<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="Access-Control-Allow-Origin" content="*"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<title>MyJobs - Jobs</title>

<script src="resources/sap-ui-core.js" type="text/javascript"
	id="sap-ui-bootstrap" 
	
	data-sap-ui-libs="sap.m,sap.ui.commons"
	data-sap-ui-theme="sap_bluecrystal">
	
</script>


<script src="myresources/js/html5sql.js"></script>  
<script src="myresources/js/bgsync.js"></script>
<script src="myresources/js/MyJobsDB.js"></script>
<script src="myresources/js/MyJobsUtils.js"></script>
<script type="text/javascript" src="cordova.js"></script>
<script type="text/javascript" src="barcodescanner.js"></script>
<script src="myresources/js/jSignature.js"></script>

<script src="myresources/js/plugins/jSignature.CompressorSVG.js"></script>
<script src="myresources/js/plugins/jSignature.UndoButton.js"></script> 
<script src="myresources/js/plugins/signhere/jSignature.SignHere.js"></script> 
<script src="myresources/js/Globals.js"></script>
<script src="myresources/js/DlgForms.js"></script>
<script src="myresources/js/NotificationFunctions.js"></script>

<style>
.formHdr {
				font-weight: bold;

			}
	#signatureparent {
		color:darkblue;
		background-color:darkgrey;
		/*max-width:600px;*/
	
		padding:20px;
	}
	
	/*This is the div within which the signature canvas is fitted*/
	#signature {
		border: 2px dotted black;
		background-color:lightgrey;
	}

	/* Drawing the 'gripper' for touch-enabled devices */ 
	html.touch #content {
		float:left;
		width:92%;
	}
	html.touch #scrollgrabber {
		float:right;
		width:4%;
		margin-right:2%;
		background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAAFCAAAAACh79lDAAAAAXNSR0IArs4c6QAAABJJREFUCB1jmMmQxjCT4T/DfwAPLgOXlrt3IwAAAABJRU5ErkJggg==)
	}
	html.borderradius #scrollgrabber {
		border-radius: 1em;
	}			
			</style>

<script type="text/javascript">
html5sql.openDatabase("com.pjo.myjobsbackfill","myjobsbackfill", 5*1024*1024);		
var map,
jobLat,
jobLon,
currentLat,
currentLon,
currentPosition,
directionsDisplay, 
directionsService;
directionsDisplay = new google.maps.DirectionsRenderer(); 
directionsService = new google.maps.DirectionsService();   
var previousFloc;
//var oLayout1 = new sap.ui.layout.form.ResponsiveGridLayout("L1");
var selectedFloc;
var formtab=null;
var tabBar=null;
var selectedFormQuestionGroup;
var selectedFormQuestionGroupTitle;
var CurrentOrderNo="";
var CurrentOpNo="";
var currentNotifNo="";
var currentOrderListItem="";
var tabContents=[]
var tabFieldCnt=0
var selectedOrderAssetID='';
var selectedReserverMaterial='';
var selectedHistoryDocument='';
//var scanner = cordova.require("cordova/plugin/BarcodeScanner");
var flocList = new sap.m.List("flocList",{
	mode: sap.m.ListMode.SingleSelectLeft,
	 itemPress:[function(oEvt) {	
		 selectedFloc=oEvt.getParameter("listItem").getId()
		  buildFlocList(oEvt.getParameter("listItem").getId())
}],
select:[function(oEvt) {	
	selectedFloc=oEvt.getParameter("listItem").getId()
	sap.ui.getCore().getElementById("NewFuncLoc").setValue(selectedFloc)
					    	formSelectFloc.close()
	 
}]
		  });
var startFloc=""
var selectedTab="";
var TabsFieldCnt=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
var Longtext;
var JobType=""
var currentStatus;
var currentPostcode;
var currentJob;
var firstJob="";
var EmployeeID = localStorage.getItem("EmployeeID")
var MapJob=getURLParameters("MapJob");
MapJob1=MapJob+":"
MapJobPar=MapJob1.split(":")
var selectedListItem=0;
var Locs = [
            {
                lat: 45.4654,
                lon: 9.1866,
                title: 'Start',
                html: '<h3>Start</h3>'
            },
            {
        		lat: 45.4654,
                lon: 9.1866,
        		title: 'Finish',
                html: '<h3>Finish</h3>'
            }
        ];
var newEQField = 			new sap.m.Input("NewEquipment",{ type: sap.m.InputType.Input,
	 icon:"images//barcode.png",
	 showValueHelp: true,
	valueHelpRequest: [function(event){
		Scan()
	
}]});
newEQField._getValueHelpIcon().setSrc("sap-icon://bar-code");
var formMaterialSearch = new sap.m.Dialog("dlgMaterial",{
    title:"Material Search Results",
    modal: true,
    contentWidth:"1em",
    buttons: [
  
				new sap.m.Button( {
				    text: "Search",
				    type: 	sap.m.ButtonType.Accept,
				    tap: [ function(oEvt) {	
				    	var opTable = sap.ui.getCore().getElementById('MaterialsSearch');
						sap.ui.getCore().getElementById('MaterialsSearch').destroyItems();
				        var url= "http://elderberry.uk.logica.com:8083/sap/bc/bsp/sap/zorderlist/MyJobsMaterialSearch.htm?jsonCallback=?&sap-client=700&sap-user=MOBILED&sap-password=logica&maktx="+sap.ui.getCore().getElementById('SearchMaterial').getValue()
				        $.getJSON(url)
				    	
						  } ]
				}),
				new sap.m.Button( {
				    text: "Close",
				    type: 	sap.m.ButtonType.Reject,
				    tap: [ function(oEvt) {		  
						 
				    	formMaterialSearch.close()
						  } ]
				})
				],	
	            contentWidth:"80%",
	            contentHeight: "70%",
    content:[
 				 			new sap.ui.layout.form.SimpleForm({
				minWidth : 1024,
				maxContainerCols : 2,
				content : [
							
			                new sap.m.Label({text:"Material"}),
							new sap.m.Input("SearchMaterial",{type: sap.m.InputType.Input}),
							

									 
					
			               
			                 
						]
 					}),
				new sap.m.Table("MaterialsSearch",{
					mode: sap.m.ListMode.SingleSelectMaster,
					selectionChange: function(evt){
						
						//selectedReserverMaterial=oEvt.getParameter("selectedItem").getKey()
						
						//sap.ui.getCore().byId("NewGroup").getSelectedItem().getKey()
						selectedReserverMaterial="RS:"+evt.getParameter("listItem").getCells()[0].getText()+":"+evt.getParameter("listItem").getCells()[1].getText()+":"+evt.getParameter("listItem").getCells()[2].getText()+":"+evt.getParameter("listItem").getCells()[3].getText()
						formReserveMaterial.open()
				    },
					columns:[
					         new sap.m.Column({header: new sap.m.Label({text:"Id"}),
					        	 hAlign: 'Left',width: '25%', minScreenWidth : "" , demandPopin: false}),
					         new sap.m.Column({header: new sap.m.Label({text:"Depot"}),
					        	 hAlign: 'Left',width: '25%',minScreenWidth : "" , demandPopin: false}),
					         new sap.m.Column({header: new sap.m.Label({text:"Description"}),
					        	 hAlign: 'Left',width: '40%',minScreenWidth : "" , demandPopin: true}),
					         new sap.m.Column({header: new sap.m.Label({text:"Qty"}),
					        	 hAlign: 'Right',width: '10%',minScreenWidth : "" , demandPopin: true })       	                         
			           	     ]
				})
            ]
 })
var formReserveMaterial = new sap.m.Dialog("dlgMaterialReserve",{
    title:"Reserve Material for Job",
    modal: true,
    contentWidth:"1em",
    buttons: [
  
				new sap.m.Button( {
				    text: "Save",
				    type: 	sap.m.ButtonType.Accept,
				    tap: [ function(oEvt) {		  
						 
				    	formReserveMaterial.close()
						  } ]
				}),
				new sap.m.Button( {
				    text: "Close",
				    type: 	sap.m.ButtonType.Reject,
				    tap: [ function(oEvt) {		  
						 
				    	formReserveMaterial.close()
						  } ]
				})
				],	
	            contentWidth:"50%",
	            contentHeight: "50%",
    content:[
 				 			new sap.ui.layout.form.SimpleForm({
				minWidth : 1024,
				maxContainerCols : 2,
				content : [
							
			                new sap.m.Label({text:"Material ID"}),
							new sap.m.Input("ReserveMaterialID",{type: sap.m.InputType.Input, enabled: false}),
			                new sap.m.Label({text:"Depot"}),
							new sap.m.Input("ReserveMaterialDepot",{type: sap.m.InputType.Input, enabled: false}),							
			                new sap.m.Label({text:"Description"}),
							new sap.m.Input("ReserveMaterialDesc",{type: sap.m.InputType.Input, enabled: false}),
			                new sap.m.Label({text:"Qty Available"}),
							new sap.m.Input("ReserveMaterialAvailable",{type: sap.m.InputType.Input, enabled: false}),									 
			                new sap.m.Label({text:"Qty Required"}),
							new sap.m.Input("ReserveMaterialRequired",{type: sap.m.InputType.Input}),					
			               
			                 
						]
 					}),

            ],
            beforeOpen:function(){
            	var x =selectedReserverMaterial.split(":")
            	sap.ui.getCore().byId("ReserveMaterialID").setValue(x[1])
				sap.ui.getCore().byId("ReserveMaterialDepot").setValue(x[2])
				sap.ui.getCore().byId("ReserveMaterialDesc").setValue(x[3])
				sap.ui.getCore().byId("ReserveMaterialAvailable").setValue(x[4])
            },
 })
var formHistoryDocument = new sap.m.Dialog("dlgHistoryDocument",{
    title:"Asset History Document",
    modal: true,
    contentWidth:"1em",
    buttons: [
  

				new sap.m.Button( {
				    text: "Close",
				    type: 	sap.m.ButtonType.Reject,
				    tap: [ function(oEvt) {		  
						 
				    	formHistoryDocument.close()
						  } ]
				})
				],	
	            contentWidth:"60%",
	            contentHeight: "60%",
    content:[
 				 			new sap.ui.layout.form.SimpleForm({
				minWidth : 1024,
				maxContainerCols : 2,
				content : [
					
							new sap.ui.layout.form.SimpleForm({
								minWidth : 1024,
								maxContainerCols : 2,
								content : [
									new sap.ui.core.Title("historyTitle",{ // this starts a new group
										text: ""
									}),

									new sap.m.Label({
										text: 'ID'
									}),
									new sap.m.Input("historyID",{
										text: 'a'
									}),
									new sap.m.Label({
										text: 'Type'
									}),
									new sap.m.Input("historyType",{
										text: 'b'
									}),
									new sap.m.Label({
										text: 'Priority'
									}),
									new sap.m.Input("historyPriority",{
										text: 'c'
									}),
									new sap.m.Label({
										text: 'Start Date'
									}),
									new sap.m.Input("historyStartDate",{
										text: 'd'
									}),
									new sap.m.Label({
										text: 'Description'
									}),
									new sap.m.Input("historyDescription",{
										text: 'e'
									}),
									new sap.m.Label({
										text: 'Details'
									}),
									new sap.m.TextArea("historyDetails",{
										text: '69190 Walldorf, Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque risus nulla, interdum eget posuere non, tincidunt' + 
												' eu felis. In hac habitasse platea dictumst. 69190 Walldorf, Lorem ipsum dolor sit amet, consectetur adipiscing elit.' + 
												' Pellentesque risus nulla, interdum eget posuere non, tincidunt eu felis. In hac habitasse platea dictumst.'
									})
									
								]
							})			
			               
			                 
						]
 					}),

            ],
            beforeOpen:function(){
            	buildHistoryForm(selectedHistoryDocument)


            },
 })
var formAssetCharacteristic = new sap.m.Dialog("dlgAssetCharacteristic",{
    title:"Asset Characteristic",
    modal: true,
    contentWidth:"1em",
    buttons: [
  
				new sap.m.Button( {
				    text: "Save",
				    type: 	sap.m.ButtonType.Accept,
				    tap: [ function(oEvt) {		  
						 
				    	formAssetCharacteristic.close()
						  } ]
				}),
				new sap.m.Button( {
				    text: "Close",
				    type: 	sap.m.ButtonType.Reject,
				    tap: [ function(oEvt) {		  
						 
				    	formAssetCharacteristic.close()
						  } ]
				})
				],	
	            contentWidth:"50%",
	            contentHeight: "50%",
    content:[
 				 			new sap.ui.layout.form.SimpleForm({
				minWidth : 1024,
				maxContainerCols : 2,
				content : [
							
			                new sap.m.Label({text:"ID"}),
							new sap.m.Input("CharacteristicID",{type: sap.m.InputType.Input, enabled: false}),
			                new sap.m.Label({text:"Description"}),
							new sap.m.Input("CharacteristicDescription",{type: sap.m.InputType.Input, enabled: false}),															 
			                new sap.m.Label({text:"Value"}),
							new sap.m.Input("CharacteristicValue",{type: sap.m.InputType.Input}),					
			               
			                 
						]
 					}),

            ],
            beforeOpen:function(){
            	var x =selectedCharacteristic.split(":")
            	sap.ui.getCore().byId("CharacteristicID").setValue(x[0])
				sap.ui.getCore().byId("CharacteristicDescription").setValue(x[1])
				sap.ui.getCore().byId("CharacteristicValue").setValue(x[2])

            },
 })
var formAssetMeasurementPoint = new sap.m.Dialog("dlgAssetMeasurementPoint",{
    title:"Asset Mdeasurement Point",
    modal: true,
    contentWidth:"1em",
    buttons: [
  
				new sap.m.Button( {
				    text: "Save",
				    type: 	sap.m.ButtonType.Accept,
				    tap: [ function(oEvt) {		  
						 
				    	formAssetMeasurementPoint.close()
						  } ]
				}),
				new sap.m.Button( {
				    text: "Close",
				    type: 	sap.m.ButtonType.Reject,
				    tap: [ function(oEvt) {		  
						 
				    	formAssetMeasurementPoint.close()
						  } ]
				})
				],	
	            contentWidth:"50%",
	            contentHeight: "50%",
    content:[
 				 			new sap.ui.layout.form.SimpleForm({
				minWidth : 1024,
				maxContainerCols : 2,
				content : [
							
			                new sap.m.Label({text:"ID"}),
							new sap.m.Input("AssetMeasurementPointID",{type: sap.m.InputType.Input, enabled: false}),
			                new sap.m.Label({text:"Description"}),
							new sap.m.Input("AssetMeasurementPointDescription",{type: sap.m.InputType.Input, enabled: false}),															 
			                new sap.m.Label({text:"Value"}),
							new sap.m.Input("AssetMeasurementPointValue",{type: sap.m.InputType.Input}),					
			               
			                 
						]
 					}),

            ],
            beforeOpen:function(){
            	var x =selectedCharacteristic.split(":")
            	sap.ui.getCore().byId("AssetMeasurementPointID").setValue(x[0])
				sap.ui.getCore().byId("AssetMeasurementPointDescription").setValue(x[1])
				sap.ui.getCore().byId("AssetMeasurementPointValue").setValue(x[2])

            },
 })
var formMaterialConsume = new sap.m.Dialog("dlgMaterialConsume",{
    title:"Consume Material",
    modal: true,
    contentWidth:"1em",
    buttons: [
  
				new sap.m.Button( {
				    text: "Save",
				    type: 	sap.m.ButtonType.Accept,
				    tap: [ function(oEvt) {		  
						 
				    	formMaterialConsume.close()
						  } ]
				}),
				new sap.m.Button( {
				    text: "Close",
				    type: 	sap.m.ButtonType.Reject,
				    tap: [ function(oEvt) {		  
						 
				    	formMaterialConsume.close()
						  } ]
				})
				],	
	            contentWidth:"50%",
	            contentHeight: "50%",
    content:[
 				 			new sap.ui.layout.form.SimpleForm({
				minWidth : 1024,
				maxContainerCols : 2,
				content : [
							
			                new sap.m.Label({text:"ID"}),
							new sap.m.Input("MaterialConsumeID",{type: sap.m.InputType.Input, enabled: false}),
			                new sap.m.Label({text:"Description"}),
							new sap.m.Input("MaterialConsumeDescription",{type: sap.m.InputType.Input, enabled: false}),
			                new sap.m.Label({text:"Assigned"}),
							new sap.m.Input("MaterialConsumeAssigned",{type: sap.m.InputType.Input, enabled: false}),
			                new sap.m.Label({text:"Used"}),
							new sap.m.Input("MaterialConsumeUsed",{type: sap.m.InputType.Input}),					
			               
			                 
						]
 					}),

            ],
            beforeOpen:function(){
            	var x =selectedCharacteristic.split(":")
            	sap.ui.getCore().byId("MaterialConsumeID").setValue(x[0])
				sap.ui.getCore().byId("MaterialConsumeDescription").setValue(x[1])
				sap.ui.getCore().byId("MaterialConsumeAssigned").setValue(x[2])

            },
 })
var formNewNotif = new sap.m.Dialog("dlgNewNotif",{
    title:" Notification",
    modal: true,
    contentWidth:"1em",
    buttons: [
					new sap.m.Button( {
					    text: "Save",
					    tap: [ function(oEvt) {	
					    	var xntype=sap.ui.getCore().byId("NewType").getSelectedItem().getKey().split("|")
					    	var xgroup=sap.ui.getCore().byId("NewGroup").getSelectedItem().getKey().split("|")
					    	var xcode=sap.ui.getCore().byId("NewCode").getSelectedItem().getKey().split("|")
					    	var xpriority=sap.ui.getCore().byId("NewPriority").getSelectedItem().getKey().split("|")
					    	
							createNotification(xntype[0],xpriority[0],xgroup[0],xcode[0],sap.ui.getCore().byId("NewGroup").getSelectedItem().getText(),
								sap.ui.getCore().byId("NewCode").getSelectedItem().getText(),sap.ui.getCore().byId("NewDescription").getValue(),
								sap.ui.getCore().byId("NewDetails").getValue(),
								sap.ui.getCore().byId("NewNotifStart").getValue(),
								sap.ui.getCore().byId("NewFuncLoc").getValue(),
								sap.ui.getCore().byId("NewEquipment").getValue())


									formNewNotif.close()
							  } ]
					   
					}),   
					new sap.m.Button( {
					    text: "Cancel",
					    tap: [ function(oEvt) {		  
							 
					    	formNewNotif.close()} ]   
					})
					],					
    content:[
 			new sap.ui.layout.form.SimpleForm({
				minWidth : 1024,
				maxContainerCols : 2,
				content : [
								
								
								new sap.m.Label({text:"Coding"}),
								new sap.m.Select('NewType',{
									
									items: [
										
									],

									change: function(oControlEvent) {
										
										BuildPriorities(oControlEvent.getParameter("selectedItem").getKey());
									}
								}),
								new sap.m.Select('NewGroup',{
									
									items: [
										
									],

									change: function(oControlEvent) {
										BuildCodes(oControlEvent.getParameter("selectedItem").getKey());
										
									}
								}),
								new sap.m.Select('NewCode',{
									
									items: [
										
									],

									change: function(oControlEvent) {
										
									}
								}),
								
								new sap.m.Label({text:"Priority"}),
								new sap.m.Select('NewPriority',{
									
									items: [
										
									],

									change: function(oControlEvent) {
										jQuery.sap.log.info("Event fired: 'change' value property to " + oControlEvent.getParameter("selectedItem") + " on " + this);
									}
								}),
								new sap.m.Label({text: "Start Date/Time:"}),
								
								new sap.m.DateTimeInput('NewNotifStart',{
									width : "99%",
									type : "DateTime",
									displayFormat : "yyyy/MM/dd hh:mm",
									dateValue : new Date()
								}),
								new sap.m.Label({text:"Description"}),
								new sap.m.Input("NewDescription",{ type: sap.m.InputType.Input}),
								
								new sap.m.Label({text:"Details"}),
								new sap.m.TextArea("NewDetails",{ rows: 3}),

			new sap.m.Label({text:"Functional Location"}),
			new sap.m.SearchField("NewFuncLoc",{
				tooltip: "Search for Functional Locations..",
				
				search: [function(event){
						selectedFloc="LGF"
				 		buildFlocList("LGF");
				 		formSelectFloc.open()
					
				}]}),

			
			new sap.m.Label({text:"Equipment",
				}),
				newEQField,								
                  
							]
 					})

            ]
	 }).addStyleClass("sapUiSizeCompact");
var formSignature = new sap.m.Dialog("dlgSignature",{
    title:"Signature",
   
    horizontalScrolling:true,
    verticalScrolling:true,
    modal: true,
    contentWidth:"1em",
    buttons: [
  
new sap.m.Button( {
    text: "Save",
    icon:"sap-icon://save",
    type: sap.m.ButtonType.Accept,
    tap: [ function(oEvt) {		  
    	SaveSignature()
    	} ]   
}),

					new sap.m.Button( {
					    text: "Clear",
					    icon:"sap-icon://sys-cancel",
					    type: sap.m.ButtonType.Reject,
					    tap: [ function(oEvt) {		  
							 
					    	ClearSignature()} ]   
					}),
					
					],					
    content:[

            ],
            contentWidth:"95%",
            contentHeight: "85%",
      beforeOpen:function(){
    	  formSignature.destroyContent()
    	  formSignature.addContent(new 		sap.ui.core.HTML({
			content: '<div id="signatureparent"><div id="signature"></div></div><div id="scrollgrabber"></div>'


		}))

      },
      afterOpen:function(){  
    	  if($('#signature').find('.jSignature').length == 0){
              $("#signature").jSignature({'UndoButton':true,  'scaleX': .5,
       'trim': true})
           };
	  } ,
	  beforeClose:function(){
		  
	  }
	
	 })
var formOrdNotification = new sap.m.Dialog("dlgOrdNotification",{
    title:"Notification", 
    horizontalScrolling:true,
    verticalScrolling:true,
    modal: true,
    contentWidth:"1em",
    buttons: [
  

					new sap.m.Button( {
					    text: "Close",
					    icon:"sap-icon://sys-cancel",
					    type: sap.m.ButtonType.Reject,
					    tap: [ function(oEvt) {		  
							 
					    	formOrdNotification.close()} ]   
					}),
					
					],					
    content:[buildNotificationDetails(),buildNotificationDetailsTabs()

            ],
            contentWidth:"95%",
            contentHeight: "85%",
      beforeOpen:function(){
    	  //formOrdNotification.destroyContent();
    	 
    	  //formOrdNotification.addContent(buildNotificationDetails(),buildNotificationDetailsTabs())
		  buildNotificationDetailsContent("Notif:"+currentNotifNo)
		  buildNotificationDetailsTabContent(currentNotifNo)
    	  selectedNotification=currentNotifNo


      },
      afterOpen:function(){  
	  } ,
	  beforeClose:function(){
		 // formOrdNotification.destroyContent();
	  }
	
	 })
var formMap = new sap.m.Dialog("dlgMap",{
    title:"Location",
   
    horizontalScrolling:true,
    verticalScrolling:true,
    modal: true,
    contentWidth:"1em",
    buttons: [
  
new sap.m.Button( {
    text: "Route",
    icon:"sap-icon://map-3",
    type: sap.m.ButtonType.Accept,
    tap: [ function(oEvt) {		  
    	formMap.close()
		formRoute.open();
    	} ]   
}),

					new sap.m.Button( {
					    text: "Close",
					    icon:"sap-icon://sys-cancel",
					    type: sap.m.ButtonType.Reject,
					    tap: [ function(oEvt) {		  
							 
					    	formMap.close()} ]   
					}),
					
					],					
    content:[

            ],
            contentWidth:"95%",
            contentHeight: "85%",
      beforeOpen:function(){
    	  formMap.addContent(new 		sap.ui.core.HTML({
			content: ' <div id="map_canvas" style="height:350px;"></div>'


		}))

      },
      afterOpen:function(){  
    	  initialize(jobLat, jobLon);
    	  document.getElementById('map_canvas').style.height=document.getElementById("dlgMap").offsetHeight-130+"px";
	  } ,
	  beforeClose:function(){
		  formMap.destroyContent();
	  }
	
	 })
var formRoute = new sap.m.Dialog("dlgRoute",{
    title:"Route",
   
    horizontalScrolling:true,
    verticalScrolling:true,
    modal: true,
    contentWidth:"1em",
    buttons: [
  

					new sap.m.Button( {
					    text: "Map",
					    icon:"sap-icon://map",
					    type: sap.m.ButtonType.Accept,
					    tap: [ function(oEvt) {		  
					    	formRoute.close()
							formMap.open();
					    	} ]   
					}),
					new sap.m.Button( {
					    text: "Close",
					    icon:"sap-icon://sys-cancel",
					    type: sap.m.ButtonType.Reject,
					    tap: [ function(oEvt) {		  
							 
					    	formRoute.close()} ]   
					}),
					
					],					
    content:
    	[
 		
 		],
            contentWidth:"95%",
            contentHeight: "95%",
     beforeOpen:function(){
    	 formRoute.addContent(new sap.ui.core.HTML({
       			//content: "<div  align='center'> <div id='gmap-route'></div><div id='route'></div><div id='controls'></div></div>"
    		 content: ' <div id="route_canvas" style="height:350px;"></div>'
       		}))
            },

      beforeClose:function(){
      		  formRoute.destroyContent();
      	  },
      afterOpen:function(){
    	 calculateRoute();
    	document.getElementById('route_canvas').style.height=document.getElementById("dlgRoute").offsetHeight-200+"px"


    		

      }      
	 })
var formPhoto = new sap.m.Dialog("dlgPhoto",{
    title:"Image",
   
    horizontalScrolling:true,
    verticalScrolling:true,
    modal: true,
    contentWidth:"1em",
    buttons: [
  


					new sap.m.Button( {
					    text: "Close",
					    icon:"sap-icon://sys-cancel",
					    type: sap.m.ButtonType.Reject,
					    tap: [ function(oEvt) {		  
							 
					    	formPhoto.close()} ]   
					})
					
					],					
    content:[
			new sap.m.Image("showPhoto",{
				width:"80%"
			})
            ],
            contentWidth:"95%",
            contentHeight: "85%",
      beforeOpen:function(){


      },
      afterOpen:function(){  
    	  x=selectedTab.split(":")

    
    	sap.ui.getCore().getElementById('showPhoto').setSrc(sap.ui.getCore().getElementById("imagePreview"+x[1]).getSrc())

	  } ,

	
	 })
var formAssetDetails = new sap.m.Dialog("dlgAssetDetails",{
    title:"Asset Details",
   
    horizontalScrolling:true,
    verticalScrolling:true,
    modal: true,
    contentWidth:"1em",
    buttons: [
  
/* new sap.m.Button( {
    text: "Save",
    icon:"sap-icon://save",
    type: sap.m.ButtonType.Accept,
    tap: [ function(oEvt) {	
    	
    	
    	formAssetDetails.close()
		
    	} ]   
}), */

					new sap.m.Button( {
					    text: "Close",
					    icon:"sap-icon://sys-cancel",
					    type: sap.m.ButtonType.Reject,
					    tap: [ function(oEvt) {		  
							 
					    	formAssetDetails.close()} ]   
					}),
					
					],					
    content:[

            ],
            contentWidth:"95%",
            contentHeight: "85%",
      beforeOpen:function(){
    	  formAssetDetails.destroyContent();
    	  
    	  BuildFormAssets(selectedOrderAssetID)

      },
      afterOpen:function(){  

	  } ,
	  beforeClose:function(){
		  

	  }
	
	 }).addStyleClass("sapUiSizeCompact")
var formQuestions = new sap.m.Dialog("dlgQuestions",{
    title:"",
   
    horizontalScrolling:true,
    verticalScrolling:true,
    modal: true,
    contentWidth:"1em",
    buttons: [
  
new sap.m.Button( {
    text: "Save",
    icon:"sap-icon://save",
    type: sap.m.ButtonType.Accept,
    tap: [ function(oEvt) {	
    	sap.ui.getCore().getElementById(selectedFormQuestionGroup).setType(sap.m.ButtonType.Accept)
    	
    	formQuestions.close()
		
    	} ]   
}),

					new sap.m.Button( {
					    text: "Close",
					    icon:"sap-icon://sys-cancel",
					    type: sap.m.ButtonType.Reject,
					    tap: [ function(oEvt) {		  
							 
					    	formQuestions.close()} ]   
					}),
					
					],					
    content:[

            ],
            contentWidth:"95%",
            contentHeight: "85%",
      beforeOpen:function(){
    	  formQuestions.destroyContent();
    	  formQuestions.setTitle(selectedFormQuestionGroupTitle);
    	  BuildFormQuestions(selectedFormQuestionGroup)

      },
      afterOpen:function(){  

	  } ,
	  beforeClose:function(){
		  saveFormQuestions(selectedFormQuestionGroup)

	  }
	
	 }).addStyleClass("sapUiSizeCompact")
var formSelectFloc = new sap.m.Dialog("dlgSelectFloc",{
    title:"",
    modal: true,
    contentWidth:"1em",
    buttons: [
  
					new sap.m.Button("flocPrevButton" ,{
						 icon:"sap-icon://navigation-up-arrow",
					    text: "previous Level",
					    tap: [ function(oEvt) {	
					    	selectedFloc=""
							var x =  formSelectFloc.getTitle().split("-")
							if (x.length==1){
								selectedFloc=x;						
							}
							var y=x.length;
							y--;
							for (var n = 0; n < y; n++) {
								selectedFloc+=x[n]
								z=n;
								z++;
								if(z!=y){
									selectedFloc=selectedFloc+"-"
									}
								}
									
		  buildFlocList(selectedFloc)
} ]   
					}),
					new sap.m.Button( {
						icon:"sap-icon://sys-cancel",
					    text: "Cancel",
					    tap: [ function(oEvt) {		  
							 
					    	formSelectFloc.close()} ]   
					})
					],					
    content:[
		
 			flocList
            ]
	 }).addStyleClass("sapUiSizeCompact");
var detailFooter = new sap.m.Bar({
		id: 'detailFooter',
		contentLeft : [
						new sap.m.Button({
							 text: "Map",
							 icon:"sap-icon://map",
							 press: [ function(){
								 formMap.open();

									}]
						 }),
							new sap.m.Button({
								 text: "Route",
								 icon:"sap-icon://map-3",
								 press: [ function(){
									 navigator.geolocation.getCurrentPosition(getDestinationDetails); 
									 formRoute.open();

										}]
							 })
						],
						contentMiddle : [
										new sap.m.Button("saveData", {
											 text: "Save",
											 visible:false,
											 icon:"sap-icon://save",
											 press: [ function(){
												 saveTheData()
													}]
										 })
										],
						contentRight : [
										new sap.m.Button("changeStatus", {
											 text: "Status",
											 icon:"sap-icon://edit",
											 press: [ function(){
												 prepareChangeStatus();
												 formChangeStatus.open();
													}]
										 })
										]
		
	})
var tconfFooter = new sap.m.Bar({
	id: 'tconfFooter',
	contentLeft : [
					new sap.m.Button({
						 text: "Map",
						 icon:"sap-icon://map",
						 press: [ function(){
							 formMap.open();

								}]
					 })
					],
	contentMiddle : [
					new sap.m.Button("tconfFooterCreateTconf", {
						 text: "Create",
						 icon: "sap-icon://create-entry-time",
						 press: [ function(){
							 
							 formTimeConf.open();
								}]
					 })
					],
	contentRight : [
					new sap.m.Button("tconfFooterChangeStatus", {
						 text: "Status",
						 icon:"sap-icon://edit",
						 press: [ function(){
							 prepareChangeStatus();
							 formChangeStatus.open();
								}]
					 })
					]
	
})
var materialFooter = new sap.m.Bar({
	id: 'materialFooter',
	contentLeft : [
					new sap.m.Button({
						 text: "Map",
						 icon:"sap-icon://map",
						 press: [ function(){
							 formMap.open();

								}]
					 })
					],
	contentMiddle : [
					new sap.m.Button({
						 text: "Search",
						 icon: "sap-icon://search",
						 press: [ function(){
							 
							 formMaterialSearch.open();
								}]
					 })
					],
	contentRight : [
					new sap.m.Button("materialFooterChangeStatus", {
						 text: "Status",
						 icon:"sap-icon://edit",
						 press: [ function(){
							 prepareChangeStatus();
							 formChangeStatus.open();
								}]
					 })
					]
	
})
var firstItem=""
var standardList  = new sap.m.List("JobList",
		  {
			  //items:standardListItem,
			  itemPress:[function(oEvt) {	
				  buildDetailsContent(oEvt.getParameter("listItem").getId());
				  localStorage.setItem("SelectedItem",oEvt.getParameter("listItem"))
				  oSplitApp.to("detail")}],
			  mode:sap.m.ListMode.SingleSelectMaster,
			  updateFinished : function(oEvent){   
		          
		      
		          }  
		  });
var historyList  = new sap.m.List("HistoryList",
		  {
			  //items:standardListItem,
			  itemPress:[function(oEvt) {	
				  selectedHistoryDocument=oEvt.getParameter("listItem").getId();
				  formHistoryDocument.open()
				}],
			  mode:sap.m.ListMode.SingleSelectMaster,
			  updateFinished : function(oEvent){   
		          
		      
		          }  
		  });
	function handleChange(oEvent) {
		var oDRS = oEvent.oSource;
		var sFrom = oEvent.getParameter("from");
		var sTo = oEvent.getParameter("to");
		var bValid = oEvent.getParameter("valid");

		

		var oText = sap.ui.getCore().byId("TextEvent");
		//oText.setText("Event " + iEvent + "\nId: " + oEvent.oSource.getId() + "\nFrom: " + sFrom + "\nTo: " + sTo + "\nvalid: " + bValid);
		if (bValid) {
			oDRS.setValueState(sap.ui.core.ValueState.None);
		} else {
			oDRS.setValueState(sap.ui.core.ValueState.Error);
		}
		
		startDate=sFrom.getFullYear().toString()+zeroFill(sFrom.getMonth()+1)+zeroFill(sFrom.getDate())
		endDate=sTo.getFullYear().toString()+zeroFill(sTo.getMonth()+1)+zeroFill(sTo.getDate())
		
	};
	var formTimeConf = new sap.m.Dialog("dlgTimeConf",{
      title:"Create Time Confirmation",
      modal: true,
      contentWidth:"1em",
      buttons: [
					new sap.m.Button( {
					    text: "Save",
					    tap: [ function(oEvt) {	
					    	
					    	
					    	createTConf(CurrentOrderNo,CurrentOpNo,sap.ui.getCore().byId("Employee").getSelectedItem().getKey(),sap.ui.getCore().byId("tconfType").getSelectedButton(),
					    			sap.ui.getCore().byId("tconfStart").getValue(),sap.ui.getCore().byId("tconfEnd").getValue(),sap.ui.getCore().byId("Duration").getValue(),
					    			sap.ui.getCore().byId("tconfType").getSelectedButton(),sap.ui.getCore().byId("Description").getValue())
							
							formTimeConf.close()
							rebuildTimeConfs()
							  } ]
					   
					}),   
					new sap.m.Button( {
					    text: "Cancel",
					    tap: [ function(oEvt) {		  
							 
					    	formTimeConf.close()} ]   
					})
					],					
      content:[
   			new sap.ui.layout.form.SimpleForm({
  				minWidth : 1024,
  				maxContainerCols : 2,
  				content : [
								new sap.m.Label({text:"Type"}),
								new sap.m.SegmentedButton('tconfType', {
									buttons: [new sap.m.Button('tconfTypeWork',{text: "Work"}),
									          new sap.m.Button('tconfTypeTravel',{text: "Travel"})
									          ], 
								}),
								
								new sap.m.Label({text:"Employee"}),
								new sap.m.Select('Employee',{
									
									items: [
										
									],

									change: function(oControlEvent) {
										jQuery.sap.log.info("Event fired: 'change' value property to " + oControlEvent.getParameter("selectedItem") + " on " + this);
									}
								}),
								new sap.m.Label({text: "Start Date/Time:"}),
								
								new sap.m.DateTimeInput('tconfStart',{
									width : "99%",
									type : "DateTime",
									displayFormat : "yyyy/MM/dd hh:mm",
									dateValue : new Date()
								}),
								new sap.m.Label({text: "End Date/Time:"}),
								new sap.m.DateTimeInput('tconfEnd',{
									width : "99%",
									type : "DateTime",
									displayFormat : "yyyy/MM/dd hh:mm",
									dateValue : new Date()
								}),   
								new sap.m.Label({text:"Duration"}),
				                 new sap.m.Slider('DurationControl',
				                		 {
				                	value: 0,
				                	max:120,
				                	min:0,
				                	step:5,
				                	change : function(){
				                		sap.ui.getCore().byId("Duration").setValue(sap.ui.getCore().byId("DurationControl").getValue());}
				                	
				                			 
				                			 
				                }), 
				  
				                new sap.m.Input("Duration",{
			                           value : sap.ui.getCore().byId("DurationControl").getValue(),
			                       type: sap.m.InputType.Input,
			                       width:"50px",
			                       change : function(){sap.ui.getCore().byId("DurationControl").setValue(parseInt(sap.ui.getCore().byId("Duration").getValue(),10));}
			                         }),
								
								new sap.m.Label({text:"Description"}),
								new sap.m.Input("Description",{ type: sap.m.InputType.Input}),
								new sap.m.Label({text:"Final"}),
								new sap.m.SegmentedButton('tconfFinal', {
									buttons: [new sap.m.Button('tconfFinalNo',{text: "No"}),
									          new sap.m.Button('tconfFinalYes',{text: "Yes"})
									          ], 
								})
				                  
							]
   					})

              ]
	 }).addStyleClass("sapUiSizeCompact");
	var formChangeStatus = new sap.m.Dialog("dlgChangeStatus",{
	      title:"Change Status",
	      modal: true,
	      contentWidth:"1em",
	      buttons: [
 
						new sap.m.Button( {
						    text: "Cancel",
						    tap: [ function(oEvt) {		  
								 
						    	formChangeStatus.close()} ]   
						})
						],					
	      content:[
	   			new sap.ui.layout.form.SimpleForm({
	  				
	  				maxContainerCols : 2,
	  				content : 	[
								new sap.m.Label({text:""}),
								new sap.m.Button('btnStatusAccept', {
						    		text: 	"Accept",
						    		icon: 	sap.ui.core.IconPool.getIconURI("accept"),
						    		type: 	sap.m.ButtonType.Accept,
						   			tap: 	[ function(oEvt) {		  								 
						    					changeStatus("Job Accepted")
						   						formChangeStatus.close()
						    					} 
						   			 		]   
									}
								),
								new sap.m.Label({text:""}),
								new sap.m.Button('btnStatusReject', {
						    		text: 	"Reject",
						    		icon: 	sap.ui.core.IconPool.getIconURI("decline"),
						    		type: 	sap.m.ButtonType.Reject,
						   			tap: 	[ function(oEvt) {		  								 
						    					changeStatus("Job Rejected")
						   						formChangeStatus.close()
						    					} 
						   			 		]   
									}
								),
								new sap.m.Label({text:""}),
								new sap.m.Button('btnStatusSuspend', {
						    		text: 	"Suspend",
						    		icon: 	sap.ui.core.IconPool.getIconURI("pause"),
						    		type: 	sap.m.ButtonType.Default,
						   			tap: 	[ function(oEvt) {		  								 
						    					changeStatus("Job Suspended")
						   						formChangeStatus.close()
						    					} 
						   			 		]   
									}
								),
								
								new sap.m.Label({text:""}),
								new sap.m.Button('btnStatusOnRoute', {
						    		text: 	"On Route",
						    		icon: 	sap.ui.core.IconPool.getIconURI("car-rental"),
						    		type: 	sap.m.ButtonType.Emphasized,
						   			tap: 	[ function(oEvt) {		  								 
						    					changeStatus("On Route")
						   						formChangeStatus.close()
						    					} 
						   			 		]   
									}
								),
								new sap.m.Label({text:""}),
								new sap.m.Button('btnStatusOnSite', {
						    		text: 	"On Site",
						    		icon: 	sap.ui.core.IconPool.getIconURI("building"),
						    		type: 	sap.m.ButtonType.Emphasized,
						   			tap: 	[ function(oEvt) {		  								 
						    					changeStatus("On Site")
						   						formChangeStatus.close()
						    					} 
						   			 		]   
									}
								)	
	              ]
		 })
	   		  ]
	 }).addStyleClass("sapUiSizeCompact");
var firstEntry="none:-1";
function prepareChangeStatus(){
	if(currentStatus=="Job Init"){
		sap.ui.getCore().getElementById('btnStatusAccept').setVisible(true);
		sap.ui.getCore().getElementById('btnStatusReject').setVisible(true);
		sap.ui.getCore().getElementById('btnStatusSuspend').setVisible(false);
		sap.ui.getCore().getElementById('btnStatusOnRoute').setVisible(false);
		sap.ui.getCore().getElementById('btnStatusOnSite').setVisible(false);
		sap.ui.getCore().getElementById('btnStatusAccept').setEnabled(true);
		sap.ui.getCore().getElementById('btnStatusReject').setEnabled(true);
	}else if(currentStatus=="Job Accepted"){
		sap.ui.getCore().getElementById('btnStatusAccept').setVisible(false);
		sap.ui.getCore().getElementById('btnStatusReject').setVisible(false);
		sap.ui.getCore().getElementById('btnStatusSuspend').setVisible(true);
		sap.ui.getCore().getElementById('btnStatusOnRoute').setVisible(true);
		sap.ui.getCore().getElementById('btnStatusOnSite').setVisible(true);
		sap.ui.getCore().getElementById('btnStatusSuspend').setEnabled(true);
		sap.ui.getCore().getElementById('btnStatusOnRoute').setEnabled(true);
		sap.ui.getCore().getElementById('btnStatusOnSite').setEnabled(false);

	}else if(currentStatus=="Job Rejected"){
		sap.ui.getCore().getElementById('btnStatusAccept').setVisible(false);
		sap.ui.getCore().getElementById('btnStatusReject').setVisible(true);
		sap.ui.getCore().getElementById('btnStatusSuspend').setVisible(false);
		sap.ui.getCore().getElementById('btnStatusOnRoute').setVisible(false);
		sap.ui.getCore().getElementById('btnStatusOnSite').setVisible(false);
		sap.ui.getCore().getElementById('btnStatusReject').setEnabled(false);

	}else if(currentStatus=="On Route"){
		sap.ui.getCore().getElementById('btnStatusAccept').setVisible(false);
		sap.ui.getCore().getElementById('btnStatusReject').setVisible(false);
		sap.ui.getCore().getElementById('btnStatusSuspend').setVisible(true);
		sap.ui.getCore().getElementById('btnStatusOnRoute').setVisible(true);
		sap.ui.getCore().getElementById('btnStatusOnSite').setVisible(true);

		sap.ui.getCore().getElementById('btnStatusSuspend').setEnabled(true);
		sap.ui.getCore().getElementById('btnStatusOnRoute').setEnabled(false);
		sap.ui.getCore().getElementById('btnStatusOnSite').setEnabled(true);

	}else if(currentStatus=="On Site"){
		sap.ui.getCore().getElementById('btnStatusAccept').setEnabled(false);
		sap.ui.getCore().getElementById('btnStatusReject').setEnabled(false);
		sap.ui.getCore().getElementById('btnStatusSuspend').setEnabled(true);
		sap.ui.getCore().getElementById('btnStatusOnRoute').setEnabled(false);
		sap.ui.getCore().getElementById('btnStatusOnSite').setEnabled(false);

	}else if(currentStatus=="Job Suspended"){
		sap.ui.getCore().getElementById('btnStatusAccept').setVisible(false);
		sap.ui.getCore().getElementById('btnStatusReject').setVisible(false);
		sap.ui.getCore().getElementById('btnStatusSuspend').setVisible(true);
		sap.ui.getCore().getElementById('btnStatusOnRoute').setVisible(true);
		sap.ui.getCore().getElementById('btnStatusOnSite').setVisible(true);
		sap.ui.getCore().getElementById('btnStatusSuspend').setEnabled(false);
		sap.ui.getCore().getElementById('btnStatusOnRoute').setEnabled(true);
		sap.ui.getCore().getElementById('btnStatusOnSite').setEnabled(false);

	}
		
	
}
function changeStatus(Status){
	var StatusState;
	var StatusIcon;

	 if(Status=="Job Init"){
		 StatusState=sap.ui.core.ValueState.None
		 StatusIcon="create"
	 }else if(Status=="Job Accepted"){
		 updateOperationStatus(CurrentOrderNo, CurrentOpNo, "JACC", "Job Accepted")
		 StatusState=sap.ui.core.ValueState.Success
		 StatusIcon="accept"
	 }else if(Status=="Job Rejected"){
		 updateOperationStatus(CurrentOrderNo, CurrentOpNo, "JREJ" ,"Job Rejected")
		 StatusState=sap.ui.core.ValueState.Error
		 StatusIcon="decline"
	 }else if(Status=="Job Suspended"){
		 updateOperationStatus(CurrentOrderNo, CurrentOpNo, "JSUS", "Job Suspended")
		 StatusState=sap.ui.core.ValueState.Warning
		 StatusIcon="pause"
	 }else if(Status=="On Route"){
		sendSMS('011447540293818','Engineer on Route')
		updateOperationStatus(CurrentOrderNo, CurrentOpNo, "JONR", "On-Route")
		 StatusState=sap.ui.core.ValueState.Success
		 StatusIcon="car-rental"
	 }else if(Status=="On Site"){
		 updateOperationStatus(CurrentOrderNo, CurrentOpNo, "JSTR", "Job Started")
		 StatusState=sap.ui.core.ValueState.Success
		 StatusIcon="building"
	 }
	currentStatus=Status;
	
	 sap.ui.getCore().getElementById('HEADER').destroyStatuses()
	 sap.ui.getCore().getElementById('HEADER').addStatus( new sap.m.ObjectStatus({
			text : Status,
			icon : sap.ui.core.IconPool.getIconURI(StatusIcon),
			state : StatusState
	 }))
	 //alert(currentOrderListItem)
	 sap.ui.getCore().getElementById(currentOrderListItem).destroyFirstStatus()
	 sap.ui.getCore().getElementById(currentOrderListItem).setFirstStatus( new sap.m.ObjectStatus({
			text : Status,
			state : StatusState
	 }))

}

function getJobType(x){
	if (x=='124699'){
		return "Quotation for Clean Water (Development Site)"
	}
	if (x=='661178'){
		return "New Water Connection"
	}
}
function buildJobs(){
var item;	
var lStatus="";
var StatusState="";
var StatusIcon="";
var res;
var jobType;
	SQLStatement="SELECT MyNotifications.pcode, MyNotifications.type as jobtype, MyOperations.orderno, MyOperationsSplit.assignedto as empid, MyOperations.opno, myuserstatus.statusdesc  as opstat, MyOrders.type, MyOperations.startdate, MyOperations.enddate, MyOrders.address,  MyOrders.postcode,MyOrders.notifno, MyOrders.gis, MyOperations.status, MyOrders.priority, MyOperations.apptstart, MyOperations.apptend, MyOrders.shorttext as orderdesc , MyOperations.shorttext as operationdesc , MyOrders.contact , MyOperationInfo.Type as infotype , MyOperationInfo.value1 as infovalue1, MyOperationInfo.value2 as infovalue2"
	SQLStatement+=" From MyOperations "
	SQLStatement+="left join myoperationinfo on myoperations.orderno = myoperationinfo.orderno "
	SQLStatement+="	and myoperations.opno = myoperationinfo.opno "
	SQLStatement+="left join myoperationssplit on myoperations.orderno = myoperationssplit.orderno "
	SQLStatement+="	and myoperations.opno = myoperationssplit.opno "
	SQLStatement+="left join myuserstatus on myoperations.orderno = myuserstatus.orderno "
	SQLStatement+="	and myoperations.opno = myuserstatus.opno "

			
		SQLStatement+="left join myorders on myoperations.orderno = myorders.orderno "
			SQLStatement+="left join mynotifications on myorders.notifno = mynotifications.notifno "
			SQLStatement+=" where myoperationssplit.assignedto = '"+EmployeeID+"' order by  MyOperations.orderno,  MyOperations.opno"
html5sql.process(SQLStatement,
		 function(transaction, results, rowsArray){

			cnt = 0;
			while (cnt<rowsArray.length){
				item=rowsArray[cnt];
				if(cnt==0){
					firstJob="job:"+item.orderno+':'+item.opno
				}
				
				if(MapJobPar[0]=="job"){
					if (MapJobPar[1]==item.orderno){
						if (MapJobPar[2]==item.opno)
							selectedListItem=cnt;
							firstJob="job:"+item.orderno+':'+item.opno
					}
				}
					
				 res=item.jobtype.split(":");
				 if(res[0]=="FORM"){
					 jobType=getJobType(res[1])
				 }else{
					 jobType=item.jobtype;
				 }
				 if(item.opstat=="Job Init"){
					 StatusState=sap.ui.core.ValueState.None
					 StatusIcon="create"
				 }else if(item.opstat=="Job Accepted"){
					 StatusState=sap.ui.core.ValueState.Success
					 StatusIcon="accept"
				 }else if(item.opstat=="Job Rejected"){
					 StatusState=sap.ui.core.ValueState.Error
					 StatusIcon="decline"
				 }else if(item.opstat=="Job Suspended"){
					 StatusState=sap.ui.core.ValueState.Warning
					 StatusIcon="pause"
				 }else if(item.opstat=="On Route"){
					 StatusState=sap.ui.core.ValueState.Success
					 StatusIcon="car-rental"
				 }else if(item.opstat=="On Site"){
					 StatusState=sap.ui.core.ValueState.Success
					 StatusIcon="building"
				 }else if(item.opstat=="Job Finished"){
					 StatusState=sap.ui.core.ValueState.Success
					 StatusIcon="complete"
				 }

				standardList.addItem(
						  new sap.m.ObjectListItem("job:"+item.orderno+':'+item.opno,
							  {
						  title:item.operationdesc,
						  number:item.type, 
						  numberUnit:item.orderno+'-'+item.opno,
						
						  type:sap.m.ListType.Active,
					
						  attributes: [
						                new sap.m.ObjectAttribute( {
						                    text: 'Start:'+formatDateTime1(item.startdate)
						                }),
						                new sap.m.ObjectAttribute( {
						                	 text: 'End:'+formatDateTime1(item.enddate)
						                }),
						                new sap.m.ObjectAttribute( {
						                	 text: 'Job Type:'+jobType
						                })
						                ],
						    firstStatus: [
						                new sap.m.ObjectStatus( {
						                    text: item.opstat,
						                    state:StatusState
						                })
						                ]
						  
							  })
						  );
					  cnt++;
			 }
			oMasterPage.destroyContent()
			oMasterPage.addContent(standardList);
			//selectListDefault();
			
		 },
		 function(error, statement){
			 alert(error+statement)
		 }        
		);	
cnt = 0;




}
function buildDetails(){

		var objectHeader  = new sap.m.ObjectHeader('HEADER',
{
			
	title:"",
	number:'',
	numberUnit:'',
	attributes: [
	               	                new sap.m.ObjectAttribute('StartDate',{
	            	                   
	            	                }),
	            	                new sap.m.ObjectAttribute('EndDate',{
	            	                    
	            	                }),
	            	                new sap.m.ObjectAttribute('Address',{
	            	                    
	            	                }),
	            	                new sap.m.ObjectAttribute('FuncLoc',{
	            	                    
	            	                }),
	            	                new sap.m.ObjectAttribute('Equipment',{
	            	                    
	            	                }),
									new sap.m.ObjectAttribute('NotifNo',{active: true,press: [ function(oEvt) {		  
										 
								    	formOrdNotification.open()} ] 
	            	                    
	            	                })
	               	                ],
	            	    firstStatus: [
	            	                new sap.m.ObjectStatus( 'State',{
	            	                  
	            	                   
	            	                })
	            	                ]

});


return objectHeader;

}

function  buildHistoryForm(did){
	
	var res = did.split(":")

	if(res[0]=='Notif'){
		SQLStatement="Select * from MyNotifications where notifno = '"+res[1]+"'"
	}else{
		SQLStatement="Select * from MyOrders where orderno = '"+res[1]+"'"
	}


	html5sql.process(SQLStatement,
		 function(transaction, results, rowsArray){

			 if (rowsArray.length>0){
				 if(res[0]=="Notif"){
					 sap.ui.getCore().getElementById('historyTitle').setText("Notification")
					 sap.ui.getCore().getElementById('historyID').setValue(rowsArray[0].notifno)
					 sap.ui.getCore().getElementById('historyType').setValue(rowsArray[0].type)
					 sap.ui.getCore().getElementById('historyPriority').setValue(rowsArray[0].priority)
					 sap.ui.getCore().getElementById('historyDescription').setValue(rowsArray[0].shorttext)
					 sap.ui.getCore().getElementById('historyDetails').setValue(rowsArray[0].longtext)
					 sap.ui.getCore().getElementById('historyStartDate').setValue(formatDateTime1(rowsArray[0].startdate))
				 }else{
					 sap.ui.getCore().getElementById('historyTitle').setText("Order")
					 sap.ui.getCore().getElementById('historyID').setValue(rowsArray[0].orderno)
					 sap.ui.getCore().getElementById('historyType').setValue(rowsArray[0].type)
					 sap.ui.getCore().getElementById('historyPriority').setValue(rowsArray[0].priority)
					 sap.ui.getCore().getElementById('historyDescription').setValue(rowsArray[0].shorttext)
					 sap.ui.getCore().getElementById('historyDetails').setValue(rowsArray[0].longtext)
					 sap.ui.getCore().getElementById('historyStartDate').setValue(formatDateTime1(rowsArray[0].startdate)	)				 
				 }
				 
		    	 
				 
			 }
	
		 },
		 function(error, statement){
			 //outputLogToDB(); 
		 }        
		);	

	 




 


	}

function  buildDetailsContent(aid){
currentOrderListItem=aid;
var res = aid.split(":")
var orderno=res[1];
var opno=res[2];
var StatusState="";
var StatusIcon="";
var tabsdesc=""
var tabsid=""
var notifno=""
var res;
var jobType;
var surveyID;
SQLStatement="SELECT MyNotifications.pcode, MyNotifications.type as notiftype, MyOperations.orderno, MyOrders.equipment,MyOrders.funcloc, MyOperationsSplit.assignedto as empid, MyOperations.opno, myuserstatus.statusdesc  as opstat, MyOrders.type, MyOperations.startdate, MyOperations.enddate, MyOrders.address, MyOrders.postcode, MyOrders.longtext as orderlongtext, MyOrders.notifno, MyOrders.gis, MyOperations.status, MyOrders.priority, MyOperations.apptstart, MyOperations.apptend, MyOrders.shorttext as orderdesc , MyOperations.shorttext as operationdesc , MyOrders.contact , MyOperationInfo.Type as infotype , MyOperationInfo.value1 as infovalue1, MyOperationInfo.value2 as infovalue2"
	SQLStatement+=" From MyOperations "
	SQLStatement+="left join myoperationinfo on myoperations.orderno = myoperationinfo.orderno "
	SQLStatement+="	and myoperations.opno = myoperationinfo.opno "
	SQLStatement+="left join myoperationssplit on myoperations.orderno = myoperationssplit.orderno "
	SQLStatement+="	and myoperations.opno = myoperationssplit.opno "
	SQLStatement+="left join myuserstatus on myoperations.orderno = myuserstatus.orderno "
	SQLStatement+="	and myoperations.opno = myuserstatus.opno "
		
	
		SQLStatement+="left join myorders on myoperations.orderno = myorders.orderno "
			SQLStatement+="left join mynotifications on myorders.notifno = mynotifications.notifno "
			SQLStatement+=" where myoperations.orderno = '"+orderno+"'"
			SQLStatement+=" and myoperations.opno = '"+opno+"'"

html5sql.process(SQLStatement,
	 function(transaction, results, rowsArray){

		 if (rowsArray.length>0){
			 currentNotifNo=rowsArray[0].notifno;
			 JobType=rowsArray[0].notiftype;
			 oDetailPage.destroyContent()
			 oDetailPage.addContent(buildDetails())

			 if(rowsArray[0].opstat=="Job Init"){
				 StatusState=sap.ui.core.ValueState.None
				 StatusIcon="create"
			 }else if(rowsArray[0].opstat=="Job Accepted"){
				 StatusState=sap.ui.core.ValueState.Success
				 StatusIcon="accept"
			 }else if(rowsArray[0].opstat=="Job Rejected"){
				 StatusState=sap.ui.core.ValueState.Error
				 StatusIcon="decline"
			 }else if(rowsArray[0].opstat=="Job Suspended"){
				 StatusState=sap.ui.core.ValueState.Warning
				 StatusIcon="pause"
			 }else if(rowsArray[0].opstat=="On Route"){
				 StatusState=sap.ui.core.ValueState.Success
				 StatusIcon="car-rental"
			 }else if(rowsArray[0].opstat=="On Site"){
				 StatusState=sap.ui.core.ValueState.Success
				 StatusIcon="building"
			 }else if(rowsArray[0].opstat=="Job Finished"){
				 StatusState=sap.ui.core.ValueState.Success
				 StatusIcon="complete"
			 }
			 res=rowsArray[0].notiftype.split(":");
			 if(res[0]=="FORM"){
				 jobType=getJobType(res[1])
				 surveyID=res[1]
				 
			 }else{
				 surveyID="0"
				 jobType=rowsArray[0].notiftype;
			 }
			 sap.ui.getCore().getElementById('HEADER').setTitle(rowsArray[0].operationdesc)
			 sap.ui.getCore().getElementById('HEADER').setNumber(rowsArray[0].orderno+"-"+rowsArray[0].opno)
			 sap.ui.getCore().getElementById('HEADER').setNumberUnit(jobType)
			 sap.ui.getCore().getElementById('HEADER').destroyStatuses()
			 sap.ui.getCore().getElementById('HEADER').addStatus( new sap.m.ObjectStatus({
					text : rowsArray[0].opstat,
					icon : sap.ui.core.IconPool.getIconURI(StatusIcon),

					state : StatusState
			 }))
			 				 currentPostcode=rowsArray[0].postcode;
			 getLatLonFromPcode(currentPostcode)
			 currentJob="job:"+rowsArray[0].orderno+':'+rowsArray[0].opno;
			 CurrentOrderNo=rowsArray[0].orderno
			 CurrentOpNo=rowsArray[0].opno
			 currentStatus=rowsArray[0].opstat;
			 if(currentStatus=="Job Finished"){
				
				 sap.ui.getCore().getElementById('tconfFooterChangeStatus').setEnabled(false)
				 sap.ui.getCore().getElementById('changeStatus').setEnabled(false)
			 }else{
				 
				 sap.ui.getCore().getElementById('tconfFooterChangeStatus').setEnabled(true)
				 sap.ui.getCore().getElementById('changeStatus').setEnabled(true)
			 }
			  sap.ui.getCore().getElementById('NotifNo').setTitle("Notification No")
			  sap.ui.getCore().getElementById('NotifNo').setText(rowsArray[0].notifno)
			  sap.ui.getCore().getElementById('StartDate').setTitle("Start Date")
			  sap.ui.getCore().getElementById('StartDate').setText(formatDate(rowsArray[0].startdate))
			  sap.ui.getCore().getElementById('EndDate').setTitle("End Date ")
			  sap.ui.getCore().getElementById('EndDate').setText(formatDate(rowsArray[0].enddate))

			  sap.ui.getCore().getElementById('Address').setTitle("Address ")	
			  sap.ui.getCore().getElementById('Address').setText(rowsArray[0].address)	
			  sap.ui.getCore().getElementById('FuncLoc').setTitle("Funcloc ")	
			  sap.ui.getCore().getElementById('FuncLoc').setText(rowsArray[0].funcloc)	
			  sap.ui.getCore().getElementById('Equipment').setTitle("Equipment ")	
			  sap.ui.getCore().getElementById('Equipment').setText(rowsArray[0].equipment)	
			  Longtext=rowsArray[0].orderlongtext	

	    	 
			 
		 }
			
		 if(JobType.length>3){
			if(surveyID!="0"){
				 oDetailPage.addContent(buildDetailsTabs("FORM",surveyID))

					
				  sap.ui.getCore().getElementById('LongText').setText(Longtext)	

				 buildDetailsTabContent(orderno,opno,"FORM",surveyID)
			}else{
			 html5sql.process("Select * from myitems where notifno = '"+currentNotifNo+"'",
					 function(transaction, results, rowsArray){
				
				 			cnt=0
				 			while(cnt < rowsArray.length){
				 				tabsdesc=tabsdesc+rowsArray[cnt].descript+":"
				 				tabsid=tabsid+rowsArray[cnt].item_id+":"
				 				cnt++;
				 			}
				 			tabsdesc=tabsdesc+"END"
				 			tabsid=tabsid+"END"
				 			oDetailPage.addContent(buildDetailsP100Tabs(tabsdesc,tabsid))
			 				
			 				buildDetailsP100TabContent(orderno,opno,currentNotifNo,tabsid)
			 				cnt=0;
			 				while(cnt < rowsArray.length){
			 					P100TabContData(currentNotifNo,rowsArray[cnt].item_id)
				 			
				 				cnt++;
				 			}
			 					
			 					
							
			 	},
				 function(error, statement){
					 //outputLogToDB(); 
				 }        
				);
			}
		 }else{
			
			 oDetailPage.addContent(buildDetailsTabs("NORMAL","0"))

			
			  sap.ui.getCore().getElementById('LongText').setText(Longtext)	

			 buildDetailsTabContent(orderno,opno,"NORMAL","0")

		 }
		 
			
		 //outputLogToDB();	
	 },
	 function(error, statement){
		 //outputLogToDB(); 
	 }        
	);	

 







}
function BuildFormAssets(assetid){
	var asset_id=""
	var asset_name=""
	var asset_type=""
	
	
	
	var	tabBar  = new sap.m.IconTabBar('AssetDetailsTabBar',
				{
					expanded:'{device>/isNoPhone}',

					select:[function(oEvt) {	
						
						  if(oEvt.getParameters().key=="AssetCharacteristics"){
							  //oDetailPage.setFooter(detailFooter)
							  }
						  if(oEvt.getParameters().key=="AssetLongText"){
							  //oDetailPage.setFooter(detailFooter)
							  }
						  if(oEvt.getParameters().key=="AssetMeasurementPoints"){
							  //oDetailPage.setFooter(detailFooter)
							  }
						  if(oEvt.getParameters().key=="AssetHistory"){
							  //oDetailPage.setFooter(materialFooter)
							  }
						  
						}
					],
					
					items: [

	
	       	                new sap.m.IconTabFilter( {
	    	                   key:'AssetLongText',
	    	                   tooltip: 'Long Text',
	    	                   icon: "sap-icon://document-text",
	    	                   content:[
										new sap.m.Text( 'AssetLongTextContent',{})
	    	                            ]
	    	                }),
	       	                
	    	                new sap.m.IconTabFilter( {
	    	            	    key:'AssetCharacteristics',
	    	            	    tooltip: 'Characteristics',
	    	            	    icon: "sap-icon://form",
	    	            	       	                   content:[
	    	            	       	        	               
	    	            									new sap.m.Table("AssetCharacteristicsTable",{
	    	            										
	    	            										mode: sap.m.ListMode.SingleSelectMaster,
	    	            										selectionChange: function(evt){
	    	            											
	    	            											//selectedReserverMaterial=oEvt.getParameter("selectedItem").getKey()
	    	            											
	    	            											//sap.ui.getCore().byId("NewGroup").getSelectedItem().getKey()
	    	            											selectedCharacteristic=evt.getParameter("listItem").getCells()[0].getText()+":"+evt.getParameter("listItem").getCells()[1].getText()+":"+evt.getParameter("listItem").getCells()[2].getText()
	    	            											formAssetCharacteristic.open()
	    	            									    },
	    	            										columns:[
	    	            										         new sap.m.Column({header: new sap.m.Label({text:"Id"}),
	    	            										        	 hAlign: 'Left',width: '25%', minScreenWidth : "" , demandPopin: false}),
	    	            										         new sap.m.Column({header: new sap.m.Label({text:"Name"}),
	    	            										        	 hAlign: 'Left',width: '25%',minScreenWidth : "" , demandPopin: true}),
	    	            										         new sap.m.Column({header: new sap.m.Label({text:"Value"}),
	    	            										        	 hAlign: 'Left',width: '50%',minScreenWidth : "" , demandPopin: true })       	                         
	    	            								           	     ]
	    	            								           	  

	    	            									})
	    	            									]
	    	            						           	  
	    	            					    }),
	       	                new sap.m.IconTabFilter( {
	        	                   key:'AssetMeasurementPoints',
	        	                   tooltip: 'Measurement Points',
	        	                   icon: "sap-icon://measuring-point",
	           	                   content:[
	    									new sap.m.Table("AssetMeasurementPointsTable",{
	    										width:'100%',
	    										mode: sap.m.ListMode.SingleSelectMaster,
        										selectionChange: function(evt){
        											
        											//selectedReserverMaterial=oEvt.getParameter("selectedItem").getKey()
        											
        											//sap.ui.getCore().byId("NewGroup").getSelectedItem().getKey()
        											selectedCharacteristic=evt.getParameter("listItem").getCells()[0].getText()+":"+evt.getParameter("listItem").getCells()[1].getText()+":"+evt.getParameter("listItem").getCells()[2].getText()
        											formAssetMeasurementPoint.open()
        									    },
	    										columns:[
	    										         
	    										         
	    										         new sap.m.Column({header: new sap.m.Label({text:"Id"}),
	    										        	 hAlign: 'Left',width: '15%', minScreenWidth : "" , demandPopin: false}),
	    										         new sap.m.Column({header: new sap.m.Label({text:"Name"}),
	    										        	 hAlign: 'Left',width: '35%',minScreenWidth : "" , demandPopin: true}),
	    										         new sap.m.Column({header: new sap.m.Label({text:"Value"}),
	    										        	 hAlign: 'Left',width: '50%',minScreenWidth : "" , demandPopin: true })
	    										        	 ]
	    									})
	    									]          	                
	        	                }),
	           	                new sap.m.IconTabFilter( 'AssetHistory',{
	         	                   key:'AssetHistory',
	         	                   tooltip: 'Order & Notification History',
	         	                   icon: "sap-icon://work-history",
	            	                   content:[

	     									]          	                
	         	                })				            	                
	       	                ]


				});

		html5sql.process("select * from myassets where orderno = '"+CurrentOrderNo+"' and id = '"+assetid+"'",
				 function(transaction, results, rowsArray){
						if(rowsArray.length>0){
							asset_id= rowsArray[0].id
							asset_name= rowsArray[0].name
							asset_type= rowsArray[0].type
							var objectHeader  = new sap.m.ObjectHeader('AssetHeader',
									{
												
										title:asset_name,
										number:asset_id,
										numberUnit:asset_type,
									});
							formAssetDetails.addContent(objectHeader)	
							formAssetDetails.addContent(tabBar)
							 sap.ui.getCore().getElementById('AssetLongTextContent').setText(asset_name)	
							
							
							
							
	
							html5sql.process("select * from assetclassvals where id = '"+assetid+"'",
									 function(transaction, results, rowsArray){
											if(rowsArray.length>0){
												var n = 0;
												var opTable = sap.ui.getCore().getElementById('AssetCharacteristicsTable');
												sap.ui.getCore().getElementById('AssetCharacteristicsTable').destroyItems();
												while (n < rowsArray.length) {
													
											
													opTable.addItem (new sap.m.ColumnListItem({
														cells : 
															[
															new sap.m.Text({text: rowsArray[n].charact}),
												            new sap.m.Text({text: rowsArray[n].description}),
															new sap.m.Text({text:  rowsArray[n].valuechar})   
													 		]
														}));
													n++;
												 }
										


														

											}
											html5sql.process("select * from assetmeasurementpoints where id = '"+assetid+"'",
													 function(transaction, results, rowsArray){
															if(rowsArray.length>0){
																var n = 0;
																var opTable = sap.ui.getCore().getElementById('AssetMeasurementPointsTable');
																sap.ui.getCore().getElementById('AssetMeasurementPointsTable').destroyItems();
																while (n < rowsArray.length) {
																	
															
																	opTable.addItem (new sap.m.ColumnListItem({
																		cells : 
																			[
																			new sap.m.Text({text: rowsArray[n].mpoint}),
																            new sap.m.Text({text: rowsArray[n].description}),
																			new sap.m.Text({text:  rowsArray[n].value})   
																	 		]
																		}));
																	n++;
																 }
														


																		

															}
															html5sql.process("Select * from MyNotifications",
																	 function(transaction, results, rowsArray){

																		cnt = 0;
																		while (cnt<rowsArray.length){
																			item=rowsArray[cnt];
																			
																			
																			
																				
																			 
																			historyList.addItem(
																					  new sap.m.ObjectListItem("Notif:"+item.notifno,
																						  {
																					  title:item.shorttext,
																					  number:item.notifno, 
																					  numberUnit:"Notification",
																					
																					  type:sap.m.ListType.Active,
																				
																					  attributes: [
																									new sap.m.ObjectAttribute( {
																									    text: 'Type:'+item.type
																									}),
																					                new sap.m.ObjectAttribute( {
																					                    text: 'Start:'+formatDateTime1(item.startdate)
																					                }),
																					                new sap.m.ObjectAttribute( {
																					                	 text: 'Reported By:'+item.reportedBy
																					                }),
																					                new sap.m.ObjectAttribute( {
																					                	 text: 'Reported On:'+formatDateTime1(item.reportedon)
																					                })
																					                ],
																					    firstStatus: [
																					                new sap.m.ObjectStatus( {
																					                    text: item.priority
																					                })
																					                ]
																					  
																						  })
																					  );
																				  cnt++;
																		 }
																		html5sql.process("Select * from MyOrders",
																				 function(transaction, results, rowsArray){

																					cnt = 0;
																					while (cnt<rowsArray.length){
																						item=rowsArray[cnt];
																						
																						
																						
																							
																						 
																						historyList.addItem(
																								  new sap.m.ObjectListItem("Order:"+item.orderno,
																									  {
																								  title:item.shorttext,
																								  number:item.orderno, 
																								  numberUnit:"Order",
																								
																								  type:sap.m.ListType.Active,
																							
																								  attributes: [
																								               new sap.m.ObjectAttribute( {
																								                    text: 'Type:'+item.type
																								                }),
																								                new sap.m.ObjectAttribute( {
																								                    text: 'Start:'+formatDateTime1(item.startdate)
																								                }),
																								                new sap.m.ObjectAttribute( {
																								                	 text: 'Address:'+item.address
																								                })
																								                ],
																								    firstStatus: [
																								                new sap.m.ObjectStatus( {
																								                    text: item.priority
																								                })
																								                ]
																								  
																									  })
																								  );
																							  cnt++;
																					 }
																					sap.ui.getCore().getElementById('AssetHistory').destroyContent();
																					sap.ui.getCore().getElementById('AssetHistory').addContent(historyList);
																					
																				 },
																				 function(error, statement){
																					 alert(error+statement)
																				 }        
																				);
																		
																		
																	 },
																	 function(error, statement){
																		 alert(error+statement)
																	 }        
																	);	
															
													 },
													 function(error, statement){
														
													 }        
													);
											
									 },
									 function(error, statement){
										
									 }        
									); 

									
									//formAssetDetails.addContent(objectHeader)	
									//formAssetDetails.addContent(tabBar)
									
						}
				 },
				 function(error, statement){
					
				 }        
				); 
	



			
}
function BuildFormQuestions(x){
	
	var HTMLToOutput='';
	var HTMLToOutput1='';
	var SQLStatement="";
	var SQLStatement1="";
	var CurrentGroup="";
	var currentSQ=""
	var pars=x.split(":")
	var surveyID=pars[1]
	var groupID=pars[2]
	var questionID=pars[3]
	var questions=[];
var hdrOP=false;

SQLStatement1="select surveyquestion.surveyid, surveyquestion.groupid, surveyquestion.questionid, surveyquestion.questiontype, surveyquestion.defaultvalue, surveyquestion.name, surveyquestion.title, surveyquestion.dependsonid, surveyquestion.dependsonval, "
SQLStatement1+="surveysubquestion.subquestionid, surveysubquestion.subquestiontype, surveysubquestion.name as subquestionname, surveysubquestion.title as subquestiontitle from surveyquestion "
SQLStatement1+="left join surveysubquestion on  "
SQLStatement1+="surveysubquestion.surveyid = surveyquestion.surveyid and "
SQLStatement1+="surveysubquestion.groupid = surveyquestion.groupid and "
SQLStatement1+="surveysubquestion.questionid = surveyquestion.questionid "
SQLStatement1+="where surveyquestion.surveyid = '"+surveyID+"' and surveyquestion.groupid = '"+groupID+"' order by surveyquestion.groupid, surveyquestion.questionid"	


					html5sql.process(SQLStatement1,
							 function(transaction, results, rowsArray){
									
									for (var nq = 0; nq < rowsArray.length; nq++) {
										itemq = rowsArray[nq];
										
											if(itemq.subquestiontype==null){
												hdrOP=false;
												BuildQuestionField(hdrOP,'set'+itemq.groupid,"Q:"+itemq.questionid,itemq.questiontype,itemq.defaultvalue,itemq.title,itemq.dependsonid, itemq.dependsonval)												
											}else{
												if(hdrOP==false){
													hdrOP=true;
													BuildQuestionField(hdrOP,'set'+itemq.groupid,"Q:"+itemq.questionid,itemq.questiontype,itemq.defaultvalue,itemq.title,itemq.dependsonid, itemq.dependsonval)												
													
												}
												BuildSubQuestionField('set'+itemq.groupid,itemq.questiontype,"Q:"+itemq.subquestionid,itemq.subquestiontype,itemq.subquestiontitle)										
											}
									}


							 },
							 function(error, statement){
								alert(error+statement)
							 }        
							); 
			
}
function saveFormQuestions(x){
	
	var HTMLToOutput='';
	var HTMLToOutput1='';
	var SQLStatement="";
	var SQLStatement1="";
	var CurrentGroup="";
	var currentSQ=""
	var pars=x.split(":")
	var surveyID=pars[1]
	var groupID=pars[2]
	var questionID=pars[3]
	var questions=[];
var hdrOP=false;
var saveDate=getDate()+getTime()
SQLStatement1="select surveyquestion.surveyid, surveyquestion.groupid, surveyquestion.questionid, surveyquestion.questiontype, surveyquestion.defaultvalue, surveyquestion.name, surveyquestion.title, surveyquestion.dependsonid, surveyquestion.dependsonval, "
SQLStatement1+="surveysubquestion.subquestionid, surveysubquestion.subquestiontype, surveysubquestion.name as subquestionname, surveysubquestion.title as subquestiontitle from surveyquestion "
SQLStatement1+="left join surveysubquestion on  "
SQLStatement1+="surveysubquestion.surveyid = surveyquestion.surveyid and "
SQLStatement1+="surveysubquestion.groupid = surveyquestion.groupid and "
SQLStatement1+="surveysubquestion.questionid = surveyquestion.questionid "
SQLStatement1+="where surveyquestion.surveyid = '"+surveyID+"' and surveyquestion.groupid = '"+groupID+"' order by surveyquestion.groupid, surveyquestion.questionid"	


					html5sql.process(SQLStatement1,
							 function(transaction, results, rowsArray){
									
									for (var nq = 0; nq < rowsArray.length; nq++) {
										itemq = rowsArray[nq];
										if(itemq.subquestiontype==null){
											hdrOP=false;
											saveQuestionField("Q:"+itemq.questionid,itemq.questiontype,surveyID,saveDate)									
										}else{
											if(hdrOP==false){
												hdrOP=true;
												saveQuestionField("Q:"+itemq.questionid,itemq.questiontype,surveyID,saveDate)									
											}
											saveQuestionField("Q:"+itemq.subquestionid,itemq.subquestiontype,surveyID,saveDate)												
										}
															}


							 },
							 function(error, statement){
								alert(error+statement)
							 }        
							); 
			
}
function BuildQuestionHeaders(surveyID){
	
	var HTMLToOutput='';
	var HTMLToOutput1='';
	var SQLStatement="";
	var SQLStatement1="";
	var CurrentGroup="";
	var currentSQ=""
	var buttons=[]
	SQLStatement="SELECT *  "
	SQLStatement+="from SurveyGroup "
	SQLStatement+="where surveyid = '"+surveyID+"'"
	formtab.destroyContent()
	var container =  new sap.m.Panel("formContainer",{
					
					content:[
					        
					         ],
					
				})
		html5sql.process(SQLStatement,
		 function(transaction, results, rowsArray){
			
				for (var n = 0; n < rowsArray.length-1; n++) {
					
					item = rowsArray[n];

					container.addContent(
							new sap.ui.layout.form.SimpleForm({
	                   			maxContainerCols: 1,
	                   		//	visible: true,
	                  			editable: true,
	                  			content: [
		      							new sap.m.Button( {
		      								id: "QH:"+surveyID+":"+item.groupid+":"+item.id,
		    							    text: item.name,
		    							    
		    							    type: 	sap.m.ButtonType.Reject,
		    							    press: [ function(oEvt) {		  
		    							    	selectedFormQuestionGroup=oEvt.getParameters().id;
		    							    	selectedFormQuestionGroupTitle=sap.ui.getCore().getElementById(oEvt.getParameters().id).getText();
		    							    	//alert(sap.ui.getCore().getElementById(oEvt.getParameters().id).getText())
		    									formQuestions.open()
		    									  } ]
		    							})
		              				]
		              		

							}))


				

				}
				
				formtab.addContent(container)
				
	 
		 },
		 function(error, statement){
			
		 }        
		);

}
function BuildQuestionField(op,panelid,id,type, defaultvalue, title,  dependsonid, dependsonval){
var mode=false;
var visible=true
if(dependsonid>0){
	visible=false;
}
    if(op){
    	if(type=='Q'){
    		formQuestions.addContent(
    				new sap.ui.layout.form.SimpleForm("F"+id,{
                   			maxContainerCols: 2,
                   			visible: visible,
                  			editable: true,
                  			content: [new sap.m.Label({text:""}),new sap.m.Text({text:title}).addStyleClass("formHdr")
                  				
                  			]}).addStyleClass("sapUiSizeCompact"))
    		return
    	}
    }

	if(type=='S'){
		
		formQuestions.addContent(
				new sap.ui.layout.form.SimpleForm("F"+id,{
               			maxContainerCols: 2,
               			visible: visible,
              			editable: true,
              			content: [new sap.m.Label({text:title+":"+type}),
new sap.m.Input(id,{ type: sap.m.InputType.Input})
              				
              			]}).addStyleClass("sapUiSizeCompact"))


	}else if (type=="Y"){
		if(defaultvalue=="N"){
			mode=false;
		}else{
			mode=true;
		}
		formQuestions.addContent(
				new sap.ui.layout.form.SimpleForm("F"+id,{
               			maxContainerCols: 2,
               			visible: visible,
              			editable: true,
              			content: [new sap.m.Label({text:title+":"+type}),
              			        new sap.m.Switch(id,{
              						state: mode,
              						change:[function(evt){
              							formChanged(evt)
              							
              						}],
              						type: sap.m.SwitchType.AcceptReject
              					})            				
              			]}).addStyleClass("sapUiSizeCompact"))
	}else if (type=="M"){
		formQuestions.addContent(
				new sap.ui.layout.form.SimpleForm("F"+id,{
               			maxContainerCols: 2,
               			visible: visible,
              			editable: true,
              			content: [new sap.m.Label({text:title+":"+type}),
              			        new sap.m.Input(id,{ type: sap.m.InputType.Input})
              				
              			]}).addStyleClass("sapUiSizeCompact"))
		
	

	}else if (type=="!"){

		formQuestions.addContent(
				new sap.ui.layout.form.SimpleForm("F"+id,{
               			maxContainerCols: 2,
               			visible: visible,
              			editable: true,
              			content: [new sap.m.Label({text:title+":"+type}),
              			        new sap.m.Input(id,{ type: sap.m.InputType.Input})
              				
              			]}).addStyleClass("sapUiSizeCompact"))
	}else if (type==";"){
		formQuestions.addContent(
				new sap.ui.layout.form.SimpleForm("F"+id,{
               			maxContainerCols: 1,
               			visible: visible,
              			editable: true,
              			content: [new sap.m.Label({text:title+":"+type}),
              			        new sap.m.Input(id,{ type: sap.m.InputType.Input})
              				
              			]}))
	}else if (type=="Q"){
		
		formQuestions.addContent(
				new sap.ui.layout.form.SimpleForm("F"+id,{
               			maxContainerCols: 2,
               			visible: visible,
              			editable: true,
              			content: [new sap.m.Label({text:title+":"+type}),
              			        new sap.m.Input(id,{ type: sap.m.InputType.Input})
              				
              			]}).addStyleClass("sapUiSizeCompact")	)	
	}else{
	
		formQuestions.addContent(
				new sap.ui.layout.form.SimpleForm("F"+id,{
               			maxContainerCols: 2,
               			visible: visible,
              			editable: true,
              			content: [new sap.m.Label({text:title+":"+type}),
              			        new sap.m.Input(id,{ type: sap.m.InputType.Input})
              				
              			]}).addStyleClass("sapUiSizeCompact"))
		}

}
function BuildSubQuestionField(panelid,type,id,subtype,title){


	if(type=='S'){
		
		formQuestions.addContent(
				new sap.ui.layout.form.SimpleForm("F"+id,{
               			maxContainerCols: 2,
              			editable: true,
              			content: [new sap.m.Label({text:title+":"+type}),
new sap.m.Input(id,{ type: sap.m.InputType.Input})
              				
              			]}).addStyleClass("sapUiSizeCompact"))


	}else if (type=="Y"){
		formQuestions.addContent(
				new sap.ui.layout.form.SimpleForm("F"+id,{
               			maxContainerCols: 2,
              			editable: true,
              			content: [new sap.m.Label({text:title+":"+type}),
              			        new sap.m.Switch(id,{
              						state: true,
              						change:[function(evt){
              							formChanged(evt)
              							
              						}],
              						type: sap.m.SwitchType.AcceptReject
              					})
              				
              			]}).addStyleClass("sapUiSizeCompact"))
	}else if (type=="M"){
		formQuestions.addContent(
				new sap.ui.layout.form.SimpleForm("F"+id,{
               			maxContainerCols: 2,
              			editable: true,
              			content: [new sap.m.Label({text:title+":"+type}),
              			        new sap.m.Input(id,{ type: sap.m.InputType.Input})
              				
              			]}).addStyleClass("sapUiSizeCompact"))
		
	

	}else if (type=="!"){

		formQuestions.addContent(
				new sap.ui.layout.form.SimpleForm("F"+id,{
               			maxContainerCols: 2,
              			editable: true,
              			content: [new sap.m.Label({text:title+":"+type}),
              			        new sap.m.Input(id,{ type: sap.m.InputType.Input})
              				
              			]}).addStyleClass("sapUiSizeCompact"))
	}else if (type==";"){
		formQuestions.addContent(
				new sap.ui.layout.form.SimpleForm("F"+id,{
               			maxContainerCols: 2,
              			editable: true,
              			content: [new sap.m.Label({text:title+":"+type}),
              			        new sap.m.Input(id,{ type: sap.m.InputType.Input})
              				
              			]}).addStyleClass("sapUiSizeCompact"))
	}else if (type=="Q"){
		
		formQuestions.addContent(
				new sap.ui.layout.form.SimpleForm("F"+id,{
               			maxContainerCols: 2,
              			editable: true,
              			content: [new sap.m.Label({text:title+":"+type}),
              			        new sap.m.Input(id,{ type: sap.m.InputType.Input})
              				
              			]}).addStyleClass("sapUiSizeCompact")	)	
	}else{
	
		formQuestions.addContent(
				new sap.ui.layout.form.SimpleForm("F"+id,{
               			maxContainerCols: 2,
              			editable: true,
              			content: [new sap.m.Label({text:title+":"+type}),
              			        new sap.m.Input(id,{ type: sap.m.InputType.Input})
              				
              			]}).addStyleClass("sapUiSizeCompact"))
		}

}
function formChanged(oEvt){
	x=oEvt.getParameters().id.split(":")
	//alert(oEvt.getParameters().id)
	//alert(sap.ui.getCore().getElementById(oEvt.getParameters().id).getText())
	var SQLStatement="Select * from surveyquestionchildren where questionid = "+x[1]
	//alert(SQLStatement)
	html5sql.process(SQLStatement,
			 function(transaction, results, rowsArray){
					currentSQ=""
					if( rowsArray.length>0) {
						
						
						items = rowsArray[0];
						var qChildren = items.childquestions.split(":");
						for (var n = 0; n < qChildren.length; n++) {
							//alert(qChildren[n])
							if(sap.ui.getCore().getElementById("FQ:"+qChildren[n]).getVisible()){
								sap.ui.getCore().getElementById("FQ:"+qChildren[n]).setVisible(false)
							}else{
								sap.ui.getCore().getElementById("FQ:"+qChildren[n]).setVisible(true)
							}
							/* if(items.questionvalue==$("#"+id).val()){
								alert("toggle"+items.questionvalue)
								$('#Div'+qChildren[n]).show();
								}else{
								$('#Div'+qChildren[n]).hide();
								} */
							}
						
					}
						
						
			 },
			 function(error, statement){
				alert("Error: " + error.message + " when SetConfigParam processing " + statement)
			 }        
			);	
}
function buildDetailsTabs(Jtype,surveyID){
tabBar=null;
formtab=null;
//sap.ui.getCore().getElementById('saveData').setVisible(false)
	if(Jtype=="FORM"){
		sap.ui.getCore().getElementById('saveData').setVisible(true)
		 formtab=new sap.m.IconTabFilter( 'FORM',{
	              key:'Form',
	              tooltip: 'Form',
	              icon: "sap-icon://form",
	              content:[

	                       ]
	           })
		 
		 BuildQuestionHeaders(surveyID)
	}
	
	tabBar  = new sap.m.IconTabBar('tabBar',
			{
				expanded:'{device>/isNoPhone}',

				select:[function(oEvt) {	
					
					  if(oEvt.getParameters().key=="Assets"){oDetailPage.setFooter(detailFooter)}
					  if(oEvt.getParameters().key=="LongText"){oDetailPage.setFooter(detailFooter)}
					  if(oEvt.getParameters().key=="Partners"){oDetailPage.setFooter(detailFooter)}
					  if(oEvt.getParameters().key=="Materials"){oDetailPage.setFooter(materialFooter)}
					  if(oEvt.getParameters().key=="TConf"){oDetailPage.setFooter(tconfFooter)}
					}
				],
				
				items: [

new sap.m.IconTabFilter( 'OBJECTS',{
    key:'Assets',
    tooltip: 'Assets',
    icon: "sap-icon://machine",
       	                   content:[
       	        	               
								new sap.m.Table("AssetsTable",{
									mode: sap.m.ListMode.SingleSelectMaster,
									selectionChange: function(oEvt){
										var x=oEvt.getParameter("listItem").getId().split(":")
										
										selectedOrderAssetID=x[1];
										formAssetDetails.open()
								    },
									columns:[
									         new sap.m.Column({header: new sap.m.Label({text:"Id"}),
									        	 hAlign: 'Left',width: '25%', minScreenWidth : "" , demandPopin: false}),
									         new sap.m.Column({header: new sap.m.Label({text:"Type"}),
									        	 hAlign: 'Left',width: '10%',minScreenWidth : "" , demandPopin: true}),
									         new sap.m.Column({header: new sap.m.Label({text:"Name"}),
									        	 hAlign: 'Left',width: '65%',minScreenWidth : "" , demandPopin: true })       	                         
							           	     ]
							           	  

								})
								]
					           	  
				    }),formtab,
       	                new sap.m.IconTabFilter( 'LONGTEXT',{
    	                   key:'LongText',
    	                   tooltip: 'Long Text',
    	                   icon: "sap-icon://document-text",
    	                   content:[
									new sap.m.Text( 'LongText',{})
    	                            ]
    	                }),
       	                
					    
       	                new sap.m.IconTabFilter( 'PARTNERS',{
        	                   key:'Partners',
        	                   tooltip: 'Partners',
        	                   icon: "sap-icon://customer-and-contacts",
           	                   content:[
    									new sap.m.Table("PartnersTable",{
    										width:'100%',
    										columns:[
    										         
    										         
    										         new sap.m.Column({header: new sap.m.Label({text:"Id"}),
    										        	 hAlign: 'Left',width: '20%', minScreenWidth : "" , demandPopin: false}),
    										         new sap.m.Column({header: new sap.m.Label({text:"Type"}),
    										        	 hAlign: 'Left',width: '10%',minScreenWidth : "" , demandPopin: true}),
    										         new sap.m.Column({header: new sap.m.Label({text:"Name"}),
    										        	 hAlign: 'Left',width: '50%',minScreenWidth : "" , demandPopin: true }),     	                         
    										         new sap.m.Column({header: new sap.m.Label({text:"TelNo"}),
    										        	 hAlign: 'Left',width: '20%',minScreenWidth : "" , demandPopin: true }),   
    										        	 ]
    									})
    									]          	                
        	                }),
           	                new sap.m.IconTabFilter( 'MATERIALS',{
         	                   key:'Materials',
         	                   tooltip: 'Materials',
         	                   icon: "sap-icon://energy-saving-lightbulb",
            	                   content:[
     									new sap.m.Table("MaterialsTable",{
     										width:'100%',
    										mode: sap.m.ListMode.SingleSelectMaster,
    										selectionChange: function(evt){
    											
    											//selectedReserverMaterial=oEvt.getParameter("selectedItem").getKey()
    											
    											//sap.ui.getCore().byId("NewGroup").getSelectedItem().getKey()
    											selectedCharacteristic=evt.getParameter("listItem").getCells()[0].getText()+":"+evt.getParameter("listItem").getCells()[1].getText()+":"+evt.getParameter("listItem").getCells()[2].getText()
    											formMaterialConsume.open()
    									    },
     										columns:[
     										         
     										         
     										         new sap.m.Column({header: new sap.m.Label({text:"Id"}),
     										        	 hAlign: 'Left',width: '30%', minScreenWidth : "" , demandPopin: false}),
     										         new sap.m.Column({header: new sap.m.Label({text:"Description"}),
     										        	 hAlign: 'Left',width: '50%',minScreenWidth : "" , demandPopin: true }),     	                         
     										         new sap.m.Column({header: new sap.m.Label({text:"Qty"}),
     										        	 hAlign: 'Left',width: '20%',minScreenWidth : "" , demandPopin: true }),   
     										        	 ]
     									})
     									]          	                
         	                }),
           	                new sap.m.IconTabFilter( 'TCONF',{
         	                   key:'TConf',
         	                  tooltip: 'Time Confirmations',
         	                  icon: "sap-icon://time-entry-request",
            	                   content:[
     									new sap.m.Table("TConfsTable",{
     										width:'100%',
     										columns:[
     										         
     										         
     										         new sap.m.Column({header: new sap.m.Label({text:"No"}),
     										        	 hAlign: 'Left',width:'10%', minScreenWidth : "" , demandPopin: false}),
         										     new sap.m.Column({header: new sap.m.Label({text:"Type"}),
         										         hAlign: 'Left',width:'10%', minScreenWidth : "" , demandPopin: false}),
             										 new sap.m.Column({header: new sap.m.Label({text:"Start"}),
     										        	 hAlign: 'Left',width:'15%', minScreenWidth : "" , demandPopin: false}),
             										 new sap.m.Column({header: new sap.m.Label({text:"End"}),
     										        	 hAlign: 'Left',width:'15%', minScreenWidth : "small" , demandPopin: true}),
             										 new sap.m.Column({header: new sap.m.Label({text:"Duration"}),
     										        	 hAlign: 'Right',width:'10%', minScreenWidth : "small" , demandPopin: true}),
	         										 new sap.m.Column({header: new sap.m.Label({text:"Fin"}),
	 										        	 hAlign: 'Left',width:'8%', minScreenWidth : "small" , demandPopin: true}),
	 										         new sap.m.Column({header: new sap.m.Label({text:"Description"}),
	 										        	 hAlign: 'Left',width:'32%', minScreenWidth : "small" , demandPopin: true}),                    
								           	     ]
     									})
     									]          	                
         	                }),				            	                
       	                ]


			});
	
	return tabBar;

	}

function buildDetailsP100Tabs(tabsdesc,tabsid){
	
tabitemsdesc=tabsdesc.split(":")
tabitemsid=tabsid.split(":")
selectedTab="Task:"+tabitemsid[0]

	var tabBar  = new sap.m.IconTabBar('tabBar',
			{
				expanded:'{device>/isNoPhone}',
				visible: false,
				select:[function(oEvt) {	
						if(selectedTab!=oEvt.getParameters().key){
							selectedTab=oEvt.getParameters().key;
						}
					}
				],
				
				items: [       	       
				      new sap.m.IconTabFilter( 'LONGTEXT',{
	                   key: 'LongText',
	                   text: 'Long Text',
	                   tooltip: 'Long Text',
	                   content:[
								new sap.m.Text( 'LongText',{})
	                            ]
	                })
			            	                
       	                ]


			});
cnt=0
while(tabitemsdesc[cnt]!="END"){
	
	tabBar.addItem(
               new sap.m.IconTabFilter( "Task:"+tabitemsid[cnt],{
	                  
	                  text:tabitemsdesc[cnt],
	                  tooltip: tabitemsdesc[cnt],
	                 
	                   content:[
								

	       	                	 new sap.ui.layout.form.SimpleForm('TaskContent:'+tabitemsid[cnt],{
	       	                			maxContainerCols: 2,
	        	              			editable: true,
	        	              			visible:false,
	        	              			content: [

	        	              				
	        	              			]
	        	              		
	       	                	 })
								]          	                
	                })			
	)
cnt=cnt+1	
}
	return tabBar;

	}
	
	
function buildDetailsP100TabContent(orderNo,OpNo,notifno,tabsid){
tabitemsid=tabsid.split(":")


	//Create Status Details
sap.ui.getCore().getElementById('saveData').setVisible(true)

sap.ui.getCore().getElementById('tabBar').setVisible(false)
var cnt=0;
	while(tabitemsid[cnt]!="END"){
		P100TabCont(notifno,tabitemsid[cnt])
		
	
	cnt=cnt+1;
	} 
	sap.ui.getCore().getElementById('tabBar').setVisible(true)
	
}

	

function P100TabCont(notifno,tabid){
var tasktext;	
var phototab;
var n = 0;
var tabcontent;
var tabcontentQ;
	html5sql.process("SELECT * FROM mytasks where notifno = '"+notifno+"' and item_id = '"+tabid+"';",
			 function(transaction, results, rowsArray){
				tabcontent = sap.ui.getCore().getElementById('Task:'+tabid);
				tabcontentQ = sap.ui.getCore().getElementById('TaskContent:'+tabid);
				tabcontentQ.destroyContent();
				n = 0;
				while (n < rowsArray.length) {
					
					
					tasktext=rowsArray[n].task_text.split(":")
					
					if(tasktext[0]=="HDR"){
						tabcontent.setTooltip(tasktext[1]);
						
					}else{
						
						tabcontentQ.addContent (new sap.m.Label({text:tasktext[1]}));
						
						if(tasktext[0]=="SIG"){
							
							//alert("T"+tabid+":"+n)
							tabcontentQ.addContent (new sap.m.Button("T"+tabid+":"+n, {
							    text: "Capture Signature",
							    icon:"sap-icon://signature",
							    type: 	sap.m.ButtonType.Accept,
							    tap: [ function(oEvt) {		
							    	formSignature.open()
							    	
									  } ]
							}));
							
							tabcontentQ.addContent (new sap.m.Label({text:"Signature Image"}));
							//tabcontentQ.addContent (new sap.ui.core.HTML({content: '<img width= "10%" id="imagePreview'+tabid+'">'}))
							tabcontentQ.addContent (new sap.m.Image('signaturePreview'+tabid,{
								width:"20%",
								tap: [ function(oEvt) {		  
									formSignature.open()
									  } ]
							}));
						}else if(tasktext[0]=="PHOTO"){
							phototab="Y"
								//alert("T"+tabid+":"+n)
								tabcontentQ.addContent (new sap.m.Button("T"+tabid+":"+n, {
								    text: "Take Photo",
								    icon:"sap-icon://add-photo",
								    type: 	sap.m.ButtonType.Accept,
								    tap: [ function(oEvt) {		
								    	//formPhoto.open()
								    	takePhoto()
										  } ]
								}));
							
								tabcontentQ.addContent (new sap.m.Label({text:"Image"}));
								//tabcontentQ.addContent (new sap.ui.core.HTML({content: '<img width= "10%" id="imagePreview'+tabid+'">'}))
								tabcontentQ.addContent (new sap.m.Image('imagePreview'+tabid,{
									width:"10%",
									tap: [ function(oEvt) {		  
										formPhoto.open()
										  } ]
								}));
							}else if(tasktext[0]=="YN"){
							tabcontentQ.addContent (new sap.m.Switch("T"+tabid+":"+n,{
								state: false,
								type: sap.m.SwitchType.AcceptReject
							}));
							
						}else if(tasktext[0]=="TXT"){
							tabcontentQ.addContent (new sap.m.Input("T"+tabid+":"+n,{type: sap.m.InputType.Text}));
							
						}else if(tasktext[0]=="NUM"){
							tabcontentQ.addContent (new sap.m.Input("T"+tabid+":"+n,{type: sap.m.InputType.Number}));
					 	}else if(tasktext[0]=="CHK"){
							tabcontentQ.addContent (new sap.m.CheckBox("T"+tabid+":"+n,{selected:false, visible: true, enabled: true}));
						}else if(tasktext[0]=="LTXT"){
							tabcontentQ.addContent (new sap.m.TextArea("T"+tabid+":"+n,{rows: 5}));
						}
					//setP100FieldVal(tasktext[0],"T"+tabid+":"+n,localStorage.getItem('MobileUser'),CurrentOrderNo,CurrentOpNo,tabid,n)	
					}
					n++;
				 }
				tabcontentQ.setVisible(true);
				
				

			 },
			 function(error, statement){
				alert(statement)
			 }        
			);	
}
function saveTheData()
{
	x=selectedTab.split(":")
	//alert("SELECT * FROM mytasks where notifno = '"+currentNotifNo+"' and item_id = '"+x[1]+"';")
	html5sql.process("SELECT * FROM mytasks where notifno = '"+currentNotifNo+"' and item_id = '"+x[1]+"';",
			 function(transaction, results, rowsArray){
			
				n = 0;
				while (n < rowsArray.length) {
					
					
					tasktext=rowsArray[n].task_text.split(":")
					
					if(tasktext[0]=="HDR"){
						//alert("Saving->"+tasktext[1])
						
					}else{
						
						
						
						if(tasktext[0]=="PHOTO"){
							saveTheAnswer(CurrentOrderNo,CurrentOpNo,localStorage.getItem('MobileUser'),
									getDate()+getTime(),x[1],n,"imagePreview"+x[1],"PHOTO")
							//alert("Saving Field->"+tasktext[1]+"Check "+"T"+x[1]+":"+n+" for photo"+$("#imagePreview"+x[1]).attr("src"))

						}else if(tasktext[0]=="YN"){
							saveTheAnswer(CurrentOrderNo,CurrentOpNo,localStorage.getItem('MobileUser'),
									getDate()+getTime(),x[1],n,sap.ui.getCore().getElementById('T'+x[1]+":"+n).getState(),"NORMAL")
							//alert("Saving Field->"+tasktext[1]+"Check "+"T"+x[1]+":"+n+" for YN"+sap.ui.getCore().getElementById('T'+x[1]+":"+n).getState())
						}else if(tasktext[0]=="TXT"){
							saveTheAnswer(CurrentOrderNo,CurrentOpNo,localStorage.getItem('MobileUser'),
									getDate()+getTime(),x[1],n,sap.ui.getCore().getElementById('T'+x[1]+":"+n).getValue(),"NORMAL")
							//alert("Saving Field->"+tasktext[1]+"Check "+"T"+x[1]+":"+n+" for TXT val"+sap.ui.getCore().getElementById('T'+x[1]+":"+n).getValue())
						}else if(tasktext[0]=="NUM"){
							saveTheAnswer(CurrentOrderNo,CurrentOpNo,localStorage.getItem('MobileUser'),
									getDate()+getTime(),x[1],n,sap.ui.getCore().getElementById('T'+x[1]+":"+n).getValue(),"NORMAL")
							//alert("Saving Field->"+tasktext[1]+"Check "+"T"+x[1]+":"+n+" for NUM val"+sap.ui.getCore().getElementById('T'+x[1]+":"+n).getValue())
					 	}else if(tasktext[0]=="CHK"){
					 		saveTheAnswer(CurrentOrderNo,CurrentOpNo,localStorage.getItem('MobileUser'),
									getDate()+getTime(),x[1],n,sap.ui.getCore().getElementById('T'+x[1]+":"+n).getSelected(),"NORMAL")
					 		//alert("Saving Field->"+tasktext[1]+"Check "+"T"+x[1]+":"+n+" for CHK"+sap.ui.getCore().getElementById('T'+x[1]+":"+n).getSelected())
						}else if(tasktext[0]=="LTXT"){
							saveTheAnswer(CurrentOrderNo,CurrentOpNo,localStorage.getItem('MobileUser'),
									getDate()+getTime(),x[1],n,sap.ui.getCore().getElementById('T'+x[1]+":"+n).getValue(),"NORMAL")
							//alert("Saving Field->"+tasktext[1]+"Check "+"T"+x[1]+":"+n+" for LTXT val"+sap.ui.getCore().getElementById('T'+x[1]+":"+n).getValue())
						}else if(tasktext[0]=="SIG"){
							saveTheAnswer(CurrentOrderNo,CurrentOpNo,localStorage.getItem('MobileUser'),
									getDate()+getTime(),x[1],n,"signaturePreview"+x[1],"SIG")
							
						}
					}
					n++;
				 }

				
				

			 },
			 function(error, statement){
				alert(statement)
			 }        
			);	
}

function P100TabContData(notifno,tabid){

	var tasktext;	
	var phototab;
	var n = 0;
	var tabcontent;
	var tabcontentQ;
	tabFieldCnt=0;
	tabContents=[];
		html5sql.process("SELECT * FROM mytasks where notifno = '"+notifno+"' and item_id = '"+tabid+"';",
				 function(transaction, results, rowsArray){
					tabFieldCnt=rowsArray.length
					n = 0;
					while (n < rowsArray.length) {	

						tasktext=rowsArray[n].task_text.split(":")					
						setP100FieldVal(tasktext[0],"T"+tabid+":"+n,localStorage.getItem('MobileUser'),CurrentOrderNo,CurrentOpNo,tabid,n)	
			
						n++;
					 }

					
					

				 },
				 function(error, statement){
					alert(statement)
				 }        
				);	
	}
function setP100FieldVal(type,fldid,user,order,opno,item,task)	{

	//alert(type+"-"+fldid+"-"+user+"-"+order+"-"+opno+"-"+item+"-"+task)
	html5sql.process("select * from JobAnswers where orderno = '"+order+
			"' and opno = '"+opno+"' and user = '"+user+"' and item = '"+item+"' and task = '"+task+"';",
				function(transaction, results, rowsArray){
					if(rowsArray.length>0){
						tabContents.push(rowsArray[0].value)
						if(type=="PHOTO"){
							$("#imagePreview"+item).attr("src",unescape(rowsArray[0].value))
						
				
						}else if(type=="YN"){
							if (rowsArray[0].value){
							sap.ui.getCore().getElementById(fldid).setState(true)
							}else{
							sap.ui.getCore().getElementById(fldid).setState(false)
							}
						}else if(type=="TXT"){
							sap.ui.getCore().getElementById(fldid).setValue(rowsArray[0].value)
							
						}else if(type=="NUM"){
							sap.ui.getCore().getElementById(fldid).setValue(rowsArray[0].value)
					 	}else if(type=="CHK"){

					 		sap.ui.getCore().getElementById(fldid).setSelected(rowsArray[0].value)
						}else if(type=="LTXT"){
							sap.ui.getCore().getElementById(fldid).setValue(rowsArray[0].value)
						}else if(type=="SIG"){
							sap.ui.getCore().getElementById("signaturePreview"+item).setSrc(unescape(rowsArray[0].value))
							
							
						}
					}else{
						tabContents.push("--NOTSET--")
					}
			 },
			 function(error, statement){
				 alert("Error: " + error.message + " when updateOrderLatLong processing " + statement);
				opMessage("Error: " + error.message + " when updateOrderLatLong processing " + statement);
			 }        
			);
}	
	
function buildDetailsTabContent(orderNo,OpNo,Jtype,surveyID){


//Create Status Details
if(Jtype=="Form"){
	tabcontent = sap.ui.getCore().getElementById('Form');
	tabContent.addContent(new sap.m.Text({text:surveyID}))
}


//Assets
html5sql.process("SELECT * FROM MyAssets where orderno = '"+orderNo+"' ;",
		 function(transaction, results, rowsArray){
			var n = 0;
			var opTable = sap.ui.getCore().getElementById('AssetsTable');
;
			sap.ui.getCore().getElementById('AssetsTable').removeAllItems();
			while (n < rowsArray.length) {
				
		
				opTable.addItem (new sap.m.ColumnListItem("Asset:"+rowsArray[n].id,{
					
					cells : 
						[
						new sap.m.Text({text: rowsArray[n].id}),
			            new sap.m.Text({text: rowsArray[n].type}),
						new sap.m.Text({text: rowsArray[n].name})   
				 		],

					}));
				n++;
			 }

		 },
		 function(error, statement){
			 //outputLogToDB(); 
		 }        
		);	
//Mpoints
html5sql.process("SELECT * FROM MyPartners where orderno = '"+orderNo+"' ;",
		 function(transaction, results, rowsArray){
			var n = 0;
			var opTable = sap.ui.getCore().getElementById('PartnersTable');
			sap.ui.getCore().getElementById('PartnersTable').removeAllItems();
			while (n < rowsArray.length) {
				
		
				opTable.addItem (new sap.m.ColumnListItem({
					cells : 
						[
						new sap.m.Text({text: rowsArray[n].id}),
			            new sap.m.Text({text: rowsArray[n].type}),
						new sap.m.Text({text: rowsArray[n].name}),
			            new sap.m.Text({text: rowsArray[n].telno})   
				 		]
					}));
				n++;
			 }

		 },
		 function(error, statement){
			 //outputLogToDB(); 
		 }        
		);	
//Materialss
html5sql.process("SELECT * FROM MyMaterials where orderno = '"+orderNo+"';",
		 function(transaction, results, rowsArray){
			var n = 0;
			var opTable = sap.ui.getCore().getElementById('MaterialsTable');
			sap.ui.getCore().getElementById('MaterialsTable').destroyItems();
			while (n < rowsArray.length) {
				
		
				opTable.addItem (new sap.m.ColumnListItem({
					cells : 
						[
						new sap.m.Text({text: rowsArray[n].material}),
			            new sap.m.Text({text: rowsArray[n].description}),
						new sap.m.Text({text: rowsArray[n].qty})  
				 		]
					}));
				n++;
			 }

		 },
		 function(error, statement){
			 //outputLogToDB(); 
		 }        
		);	
 //Time Confirmations
html5sql.process("SELECT * FROM MyTimeConfs where orderno = '"+orderNo+"' and opno = '"+OpNo+"' ;",
		 function(transaction, results, rowsArray){
			var n = 0;
			var opTable = sap.ui.getCore().getElementById('TConfsTable');
			sap.ui.getCore().getElementById('TConfsTable').destroyItems();
			while (n < rowsArray.length) {
				
		
				opTable.addItem (new sap.m.ColumnListItem({
					cells : 
						[
						new sap.m.Text({text: parseInt(rowsArray[n].confno,10)}),
			            new sap.m.Text({text: rowsArray[n].type}),
						new sap.m.Text({text: formatDateTime(rowsArray[n].date+rowsArray[n].time)}),
			            new sap.m.Text({text: formatDateTime(rowsArray[n].enddate+rowsArray[n].endtime)}),
						new sap.m.Text({text: rowsArray[n].duration}),
			            new sap.m.Text({text: rowsArray[n].final}),
			           
						new sap.m.Text({text:  rowsArray[n].description})   
				 		]
					}));
				n++;
			 }

		 },
		 function(error, statement){
			 //outputLogToDB(); 
		 }        
		);	


}

function rebuildTimeConfs()
{

	html5sql.process("SELECT * FROM MyTimeConfs where orderno = '"+CurrentOrderNo+"' and opno = '"+CurrentOpNo+"' ;",
			 function(transaction, results, rowsArray){
				var n = 0;
				var opTable = sap.ui.getCore().getElementById('TConfsTable');
				sap.ui.getCore().getElementById('TConfsTable').destroyItems();
				while (n < rowsArray.length) {
					
			
					opTable.addItem (new sap.m.ColumnListItem({
						cells : 
							[
							new sap.m.Text({text: rowsArray[n].confno}),
				            new sap.m.Text({text: rowsArray[n].type}),
							new sap.m.Text({text: formatDateTime(rowsArray[n].date+rowsArray[n].time)}),
				            new sap.m.Text({text: formatDateTime(rowsArray[n].enddate+rowsArray[n].endtime)}),
							new sap.m.Text({text: rowsArray[n].duration}),
				            new sap.m.Text({text: rowsArray[n].final}),
				           
							new sap.m.Text({text:  rowsArray[n].description})   
					 		]
						}));
					n++;
				 }

			 },
			 function(error, statement){
				 //outputLogToDB(); 
			 }        
			);	

}
	var oDetailPage = new sap.m.Page(
			"detail",
			{
				title : "Job Details",
				content : [],
				footer: detailFooter,
				showNavButton: true,
					 
					 navButtonPress: function() {				                  
						 window.location.href="Jobs.html"
					 }
			}).addStyleClass("sapUiStdPage");


	//create first master page

	var oMasterPage = new sap.m.Page(
			"master",
			{
				 headerContent : new sap.m.Button({
                     icon: "sap-icon://home",
                     press : function() {
                    	 window.location.href="Home.html"
                     }
}),
				title : "Jobs",
				
				content : [ buildJobs()],
				showNavButton: "{device>/isPhone}" ,
				footer  : new sap.m.Bar (
						{
							id : 'master-footer',

							contentLeft : [
									new sap.m.Button("Add1", {
					   					 text: "create",
					  					 press: [ function(){
					  						startFloc="LGF"
					  						formNewNotif.open(); 
					  						
					  							}]
										 })
								]
						})			 

			});
	
	
	
	
	//create SplitApp()
	var oSplitApp = new sap.m.SplitApp({
		detailPages: [oDetailPage],
		masterPages: [oMasterPage],
		initialDetail: "detail",
		initialMaster: "master",
		afterMasterOpen: function(){
			jQuery.sap.log.info("master is opened");
		},
		afterMasterClose: function(){
			jQuery.sap.log.info("master is closed");
		}
	});

	if(jQuery.device.is.tablet || jQuery.device.is.desktop){
		oSplitApp.setDefaultTransitionNameDetail("fade");	
	}

	oSplitApp.placeAt("body");
	//selectListDefault();
</script>
</head>
<body id="body" class="sapUiBody">
<script>
$(function() {
	$.getScript("http://maps.googleapis.com/maps/api/js?sensor=false")
	oSplitApp.onAfterRendering = function() {  
		//selectListDefault() 
        }  
		
	BuildNotificationTypes()
	BuildTCEmployees()
	
	});
function selectListDefault(){

	firstItem = sap.ui.getCore().getElementById("JobList").getItems()[selectedListItem];   

	sap.ui.getCore().getElementById("JobList").setSelectedItem(firstItem,true);
	  buildDetailsContent(firstJob);
	  oSplitApp.to("detail");
}
function onCamSuccess(imageData) {
x=selectedTab.split(":")

	//$("#imagePreview"+x[1]).attr("src", imageData);
sap.ui.getCore().getElementById("imagePreview"+x[1]).setSrc(imageData)
	}

	function onCamFail(message) {
	    alert('Failed because: ' + message);
	}
	function takePhoto(){
	
		navigator.camera.getPicture(onCamSuccess, onCamFail, {quality:100, destinationType:Camera.DestinationType.FILE_URI});

	}

function buildFlocList(parentid)
{
var fid=parentid.split("-")

var sqlstatement = "select * from funclocs where parentid='"+parentid+"'"
flocList.destroyItems();
previousFloc=formSelectFloc.getTitle();
formSelectFloc.setTitle(selectedFloc)

var fidpos=fid.length

html5sql.process(sqlstatement,
		 function(transaction, results, rowsArray){
			var n = 0;
			

			
			while (n < rowsArray.length) {
				if(rowsArray[n].children=="1"){
					liType=sap.m.ListType.Navigation
				}else{
					liType=sap.m.ListType.None
				}
				fid=rowsArray[n].flid.split("-")
				flocList.addItem (new sap.m.StandardListItem(rowsArray[n].flid,{	
					type: liType,
					
					
					title : fid[fidpos]+" : "+unescape(rowsArray[n].description)}))
					
				
				n++;
			 }
			if(fidpos==1){
				sap.ui.getCore().getElementById("flocPrevButton").setVisible(false)
			}else{
				sap.ui.getCore().getElementById("flocPrevButton").setVisible(true)
			}
				
		 },
		 function(error, statement){
			 //outputLogToDB(); 
		 }        
		);
}
function Scan(){

	{
		var scanner = cordova.require("cordova/plugin/BarcodeScanner");
	        
	      

	        scanner.scan( function (result) { 

	            //alert("We got a barcode\n" + 
	            //"Result: " + result.text + "\n" + 
	            //"Format: " + result.format + "\n" + 
	            //"Cancelled: " + result.cancelled);  

	          
	            sap.ui.getCore().getElementById("NewEquipment").setValue(result.text);
	           // alert(result);


	        }, function (error) { 
	           //alert("Scanning failed: ", error); 
	        } );
	    }
	}
function BuildTCEmployees(){
	var SQLStatement="";
	var FirstVal="";
	SQLStatement="SELECT * from Myrefusers "

	
		html5sql.process(SQLStatement,
		 function(transaction, results, rowsArray){
				//alert(rowsArray.length)
				for (var n = 0; n < rowsArray.length; n++) {
					item = rowsArray[n];
					sap.ui.getCore().getElementById("Employee").addItem(
							new sap.ui.core.Item({
								key: "Emp|"+item.id+"|"+item.employeeno, 
								text: item.firstname+" "+item.lastname
							}))
					
				}
					
				
		 },
		 function(error, statement){
			
		 }        
		);
}
function BuildNotificationTypes(){

	var HTMLToOutput='';

	var SQLStatement="";
	var FirstVal="";
	SQLStatement="SELECT MyRefNotifTypes.type , MyRefNotifTypes.description, MyRefNotifTypes.priority_type, profile from MyRefNotifTypes "
	SQLStatement+="join RefNotifprofile on MyRefNotifTypes.type = RefNotifprofile.notif_type "
	SQLStatement+="where MyRefNotifTypes.scenario = 'MAMDEMOLG'"
	
		html5sql.process(SQLStatement,
		 function(transaction, results, rowsArray){
				//alert(rowsArray.length)
				for (var n = 0; n < rowsArray.length; n++) {
					item = rowsArray[n];
					sap.ui.getCore().getElementById("NewType").addItem(
							new sap.ui.core.Item({
								key: item.type+"|"+item.priority_type+"|"+item.profile, 
								text: item.description
							}))
					
				}
					
				
		 },
		 function(error, statement){
			
		 }        
		);

	}
	
	function BuildPriorities(selectedId){
		
var x = selectedId.split("|")
var priority_type = x[1];
var profile=x[2];
	var HTMLToOutput='';

	var SQLStatement="";
	var FirstVal="";
	SQLStatement="SELECT priority , description "
	SQLStatement+="from MyRefPriorityTypes "
	SQLStatement+="where scenario = 'MAMDEMO' and type = '"+priority_type+"'"
	var HTMLToOutput="";
		html5sql.process(SQLStatement,
		 function(transaction, results, rowsArray){
			
			sap.ui.getCore().getElementById("NewPriority").destroyItems();
			
				for (var n = 0; n < rowsArray.length; n++) {
					item = rowsArray[n];
					sap.ui.getCore().getElementById("NewPriority").addItem(
							new sap.ui.core.Item({
								key: item.priority,
								text: item.description
							}))
				}
			BuildGroups(profile)
				
		 },
		 function(error, statement){
			
		 }        
		);

	}
	function BuildGroups(profile){



		var SQLStatement="";
		var FirstVal="";
		SQLStatement="SELECT *  "
		SQLStatement+="from RefCodeGroups "
		SQLStatement+="where scenario = 'MAMDEMO' and catalog_type = 'X' and profile = '"+profile+"'"
		var HTMLToOutput="";
			html5sql.process(SQLStatement,
			 function(transaction, results, rowsArray){

					sap.ui.getCore().getElementById("NewGroup").destroyItems();
					
					for (var n = 0; n < rowsArray.length; n++) {
						item = rowsArray[n];
						sap.ui.getCore().getElementById("NewGroup").addItem(
								new sap.ui.core.Item({
									key: profile+"|"+item.code_cat_group,
									text: item.codegroup_text
								}))
					}
					
			 },
			 function(error, statement){
				
			 }        
			);

		}
	function BuildCodes(Group){

		var HTMLToOutput='';

		var SQLStatement="";
		var res = Group.split("|")
		
		SQLStatement="SELECT *  "
		SQLStatement+="from RefCodes "
		SQLStatement+="where scenario = 'MAMDEMO' and profile = '"+res[0]+"' and code_cat_group = '"+res[1]+"'"
		var HTMLToOutput="";
			html5sql.process(SQLStatement,
			 function(transaction, results, rowsArray){

					sap.ui.getCore().getElementById("NewCode").destroyItems();
					
					for (var n = 0; n < rowsArray.length; n++) {
						item = rowsArray[n];
						sap.ui.getCore().getElementById("NewCode").addItem(
								new sap.ui.core.Item({
									key: item.code,
									text: item.code_text
								}))
					}
			 },
			 function(error, statement){
				
			 }        
			);

		}

	function getDestinationDetails(currentLatLon)
	{
		Locs[0]['lat']=currentLatLon.coords.latitude;
		Locs[0]['lon']=currentLatLon.coords.longitude;
		
	
		formRoute.open()
		//window.location.href='Route.html?PostCode='+PostCode+'&Job='+Job+'&SLat='+Start_lat+'&SLon='+Start_lon+'&ELat='+End_lat+'&ELon='+End_lon
	    
	    
	}
    function initialize(lat, lon)
    {
        

        currentPosition = new google.maps.LatLng(lat, lon);

        map = new google.maps.Map(document.getElementById('map_canvas'), {
           zoom: 15,
           center: currentPosition,
           mapTypeId: google.maps.MapTypeId.ROADMAP
         });

       // directionsDisplay.setMap(map);

         var currentPositionMarker = new google.maps.Marker({
            position: currentPosition,
            map: map,
            title: "Current position"
        });

        var infowindow = new google.maps.InfoWindow();
        google.maps.event.addListener(currentPositionMarker, 'click', function() {
            infowindow.setContent("Current position: latitude: " + lat +" longitude: " + lon);
            infowindow.open(map, currentPositionMarker);
        });
    }

    function locError(error) {
        // initialize map with a static predefined latitude, longitude
       initialize(59.3426606750, 18.0736160278);
    }

    function locSuccess(position) {
        initialize(position.coords.latitude, position.coords.longitude);
    }

    function calculateRoute() {
    	 

        var targetDestination = new google.maps.LatLng(jobLat, jobLon);
        var currentPosition = new google.maps.LatLng(currentLat, currentLon);

            var request = {
                origin:currentPosition, 
                destination:targetDestination,
                travelMode: google.maps.DirectionsTravelMode["DRIVING"]
            };

            directionsService.route(request, function(response, status) {
                if (status == google.maps.DirectionsStatus.OK) {
                    directionsDisplay.setPanel(document.getElementById("route_canvas"));
                    directionsDisplay.setDirections(response); 


                }
                else {
                	
                }
            });

    }

    function locationHandler(position)
	 {
	   currentLat = position.coords.latitude;
	   currentLon = position.coords.longitude;
	 }
    function getLatLonFromPcode(address) {
    	navigator.geolocation.getCurrentPosition(locationHandler);

    	
    var geocoder = new google.maps.Geocoder();
    geocoder.geocode({'address': address+" , UK"}, function postcodesearch(results, status) 
    {   
      if (status == google.maps.GeocoderStatus.OK) 
      {
        jobLat=results[0].geometry.location.lat()
        jobLon=results[0].geometry.location.lng()
      }
      else {
       
      }

    })
    };
    function ClearSignature(){
		$("#signature").jSignature('reset')
}
function SaveSignature(){
	var	data = $("#signature").jSignature('getData', 'svgbase64')
		
		x=selectedTab.split(":")

	//$("#imagePreview"+x[1]).attr("src", imageData);
sap.ui.getCore().getElementById("signaturePreview"+x[1]).setSrc( "data:" + data[0] + "," + data[1] )
formSignature.close()

		//UpdateSignatureSurveyHDR(escape(data[1]))
		
}
</script>
</body>
</html>
