<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="Access-Control-Allow-Origin" content="*"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<title>MyJobs - TimeSheet</title>
<script src="resources/sap-ui-core.js" type="text/javascript"
	id="sap-ui-bootstrap" data-sap-ui-libs="sap.m,sap.ui.commons"
	data-sap-ui-theme="sap_bluecrystal">
	
</script>

<script src="myresources/js/buildDetails.js"></script>
<script src="myresources/js/html5sql.js"></script>  
<script src="myresources/js/bgsync.js"></script>
<script src="myresources/js/MyJobsDB.js"></script>
<script src="myresources/js/MyJobsUtils.js"></script>
<script type="text/javascript">
html5sql.openDatabase("com.pjo.myjobsbackfill","myjobsbackfill", 5*1024*1024);		
var currentStatus;
var firstNotification="";
var EmployeeID = localStorage.getItem("EmployeeID")
var detailFooter = new sap.m.Bar({
		id: 'detailFooter',
		contentRight : [
						
						]
		
	})

var standardList  = new sap.m.List(
		  {
			  //items:standardListItem,
			  itemPress:[function(oEvt) {		  
				  buildDetailsContent(oEvt.getParameter("listItem").getId());
				 
				  oSplitApp.to("detail")}],
			  mode:sap.m.ListMode.SingleSelectMaster
		  });
	function handleChange(oEvent) {
		var oDRS = oEvent.oSource;
		var sFrom = oEvent.getParameter("from");
		var sTo = oEvent.getParameter("to");
		var bValid = oEvent.getParameter("valid");

		

		var oText = sap.ui.getCore().byId("TextEvent");
		//oText.setText("Event " + iEvent + "\nId: " + oEvent.oSource.getId() + "\nFrom: " + sFrom + "\nTo: " + sTo + "\nvalid: " + bValid);
		if (bValid) {
			oDRS.setValueState(sap.ui.core.ValueState.None);
		} else {
			oDRS.setValueState(sap.ui.core.ValueState.Error);
		}
		
		startDate=sFrom.getFullYear().toString()+zeroFill(sFrom.getMonth()+1)+zeroFill(sFrom.getDate())
		endDate=sTo.getFullYear().toString()+zeroFill(sTo.getMonth()+1)+zeroFill(sTo.getDate())
		
	};
	
var firstEntry="none:-1";

var formNewNotif = new sap.m.Dialog("dlgNewNotif",{
    title:"Create Notification",
    modal: true,
    contentWidth:"1em",
    buttons: [
					new sap.m.Button( {
					    text: "Save",
					    tap: [ function(oEvt) {		  
							/* createTimeConf(AbsenceType,startDate,endDate,
									sap.ui.getCore().byId("Days").getValue(),
									sap.ui.getCore().byId("Description").getValue(),
									sap.ui.getCore().byId("Comments").getValue());  */
									formNewNotif.close()
							  } ]
					   
					}),   
					new sap.m.Button( {
					    text: "Cancel",
					    tap: [ function(oEvt) {		  
							 
					    	formNewNotif.close()} ]   
					})
					],					
    content:[
 			new sap.ui.layout.form.SimpleForm({
				minWidth : 1024,
				maxContainerCols : 2,
				content : [
								
								
								new sap.m.Label({text:"Coding"}),
								new sap.m.Select('NewType',{
									
									items: [
										new sap.ui.core.Item({
											key: "1",
											text: "M1 Notification"
										}),

										new sap.ui.core.Item({
											key: "2",
											text: "M2 Notification"
										}),

										new sap.ui.core.Item({
											key: "3",
											text: "M3 - Notification"
										})
									],

									change: function(oControlEvent) {
										jQuery.sap.log.info("Event fired: 'change' value property to " + oControlEvent.getParameter("selectedItem") + " on " + this);
									}
								}),
								new sap.m.Select('NewSource',{
									
									items: [
										new sap.ui.core.Item({
											key: "1",
											text: "General"
										}),

										new sap.ui.core.Item({
											key: "2",
											text: "Hardware"
										}),

										new sap.ui.core.Item({
											key: "3",
											text: "Software"
										})
									],

									change: function(oControlEvent) {
										jQuery.sap.log.info("Event fired: 'change' value property to " + oControlEvent.getParameter("selectedItem") + " on " + this);
									}
								}),
								new sap.m.Select('Code',{
									
									items: [
										new sap.ui.core.Item({
											key: "1",
											text: "Code 1"
										}),

										new sap.ui.core.Item({
											key: "2",
											text: "Code 2"
										}),

										new sap.ui.core.Item({
											key: "3",
											text: "Code 3"
										})
									],

									change: function(oControlEvent) {
										jQuery.sap.log.info("Event fired: 'change' value property to " + oControlEvent.getParameter("selectedItem") + " on " + this);
									}
								}),
								
								new sap.m.Label({text:"Priority"}),
								new sap.m.Select('NewPriority',{
									
									items: [
										new sap.ui.core.Item({
											key: "1",
											text: "Red"
										}),

										new sap.ui.core.Item({
											key: "2",
											text: "Amber"
										}),

										new sap.ui.core.Item({
											key: "3",
											text: "Green"
										})
									],

									change: function(oControlEvent) {
										jQuery.sap.log.info("Event fired: 'change' value property to " + oControlEvent.getParameter("selectedItem") + " on " + this);
									}
								}),
								new sap.m.Label({text: "Start Date/Time:"}),
								
								new sap.m.DateTimeInput('NewNotifStart',{
									width : "99%",
									type : "DateTime",
									displayFormat : "yyyy/MM/dd hh:mm",
									dateValue : new Date()
								}),
								new sap.m.Label({text:"Description"}),
								new sap.m.Input("NewDescription",{ type: sap.m.InputType.Input}),
								
								new sap.m.Label({text:"Details"}),
								new sap.m.TextArea("NewDetails",{ rows: 3}),

			new sap.m.Label({text:"Functional Location"}),
			new sap.m.Input("NewFuncLoc",{ type: sap.m.InputType.Input}),
			
			new sap.m.Label({text:"Equipment"}),
			new sap.m.Input("NewEquipment",{ type: sap.m.InputType.Input}),								
				                  
							]
 					})

            ]
	 })
function buildTimeSheets(){
var item;	
var lStatus="";
var StatusState="";
var StatusIcon="";
	SQLStatement="SELECT * from tsdata where job='header'"
html5sql.process(SQLStatement,
		 function(transaction, results, rowsArray){

			cnt = 0;
			while (cnt<rowsArray.length){
				if(cnt==0){
					firstTsheet="tsheet:"+item.id
				}
				item=rowsArray[cnt];
				if (item.activity=="SUBMITTED"){
					StatusState="Error"
				}else{
					StatusState="Success"
				}
				 
				standardList.addItem(
						  new sap.m.ObjectListItem("tsheet:"+item.id,
							  {
						  title:item.date,
						 
						  type:sap.m.ListType.Active,
					
						
						    firstStatus: [
						                new sap.m.ObjectStatus( {
						                    text: item.activity,
						                    state:StatusState
						                })
						                ]
					
							  })
						  );
					  cnt++;
			 }
			oMasterPage.destroyContent()
			oMasterPage.addContent(standardList);
			buildDetailsContent(firstTsheet)
		 },
		 function(error, statement){
			 alert(error+statement)
		 }        
		);	
cnt = 0;




}
function buildDetails(){
	
		var objectHeader  = new sap.m.ObjectHeader('HEADER',
{
			
	title:"",
	number:'',
	numberUnit:'',
	           
	            	    firstStatus: [
	            	                new sap.m.ObjectStatus( 'State',{
	            	                  
	            	                   
	            	                })
	            	                ]

});


return objectHeader;

}



function buildDetailsContent(aid){

var res = aid.split(":")
var tsheet=res[1];

var StatusState="";
var StatusIcon="";
var Status
SQLStatement="SELECT * from tsdata where id = '"+tsheet+"'"
selectedData;
html5sql.process(SQLStatement,
	 function(transaction, results, rowsArray){

		 if (rowsArray.length>0){
			 if(rowsArray[0].activity=="SUBMITTED"){
				 StatusState="ERROR"
			 }
			 
			 sap.ui.getCore().getElementById('HEADER').setTitle(rowsArray[0].date)
			selectedDate=rowsArray[0].date;
			 sap.ui.getCore().getElementById('HEADER').destroyStatuses()
			 sap.ui.getCore().getElementById('HEADER').addStatus( new sap.m.ObjectStatus({
					text : rowsArray[0].activity,
					

					state : StatusState
			 }))
			
			  

			 
		 }
		
		 html5sql.process("SELECT * FROM tsdata where activity <> 'header' date = '"+selectedDate+"' ;",
				 function(transaction, results, rowsArray){
					var n = 0;
					var opTable = sap.ui.getCore().getElementById('ActivitiesTable');
					opTable.removeAllItems();
					while (n < rowsArray.length) {
						
				
						opTable.addItem (new sap.m.ColumnListItem({
							cells : 
								[
								new sap.m.Text({text: rowsArray[n].date}),
					            new sap.m.Text({text: rowsArray[n].job}),
								new sap.m.Text({text: rowsArray[n].skill}),			    
								new sap.m.Text({text: rowsArray[n].activity}),
					            new sap.m.Text({text: rowsArray[n].time}),
					            new sap.m.Text({text: rowsArray[n].ot15}),
					            new sap.m.Text({text: rowsArray[n].ot20})   
						 		]
							}));
						n++;
					 }

				 },
				 function(error, statement){
					 //outputLogToDB(); 
				 }        
				);	
	 },
	 function(error, statement){
		 //outputLogToDB(); 
	 }        
	);	

 








}

function buildDetailsTable(){
	
       
     	     var TsheetData=          
								new sap.m.Table("TsheetTable",{
									columns:[
									         new sap.m.Column({header: new sap.m.Label({text:"Date"}),
									        	 hAlign: 'Left',width: '16%', minScreenWidth : "" , demandPopin: false}),
									         new sap.m.Column({header: new sap.m.Label({text:"Job"}),
									        	 hAlign: 'Left',width: '15%',minScreenWidth : "" , demandPopin: true}),
									         new sap.m.Column({header: new sap.m.Label({text:"Skill"}),
									        	 hAlign: 'Left',width: '15%', minScreenWidth : "" , demandPopin: false}),
									         new sap.m.Column({header: new sap.m.Label({text:"Activity"}),
									        	 hAlign: 'Left',width: '15%',minScreenWidth : "" , demandPopin: true}),
									         new sap.m.Column({header: new sap.m.Label({text:"Time"}),
									        	 hAlign: 'Left',width: '13%', minScreenWidth : "" , demandPopin: false}),
										
									         new sap.m.Column({header: new sap.m.Label({text:"OT15"}),
									        	 hAlign: 'Left',width: '13%', minScreenWidth : "" , demandPopin: false}),
									         new sap.m.Column({header: new sap.m.Label({text:"OT20"}),
									        	 hAlign: 'Left',width: '13%',minScreenWidth : "" , demandPopin: true })       	                         
							           	     ]
								})
			
	return TsheetData;

	}





	var oDetailPage = new sap.m.Page(
			"detail",
			{
				title : "Notiofication Details",
				content : [buildDetails()],
				showNavButton: true,
					 
					 navButtonPress: function() {				                  
						window.location.reload()
					 }
			}).addStyleClass("sapUiStdPage");


	//create first master page

	var oMasterPage = new sap.m.Page(
			"master",
			{
				 headerContent : new sap.m.Button({
                     icon: "sap-icon://home",
                     press : function() {
                    	 window.location.href="Home.html"
                     }
}),
				title : "Notifications",
				
				content : [ buildTimeSheets()],
				showNavButton: "{device>/isPhone}" ,
				footer  : new sap.m.Bar (
						{
							id : 'master-footer',

							contentLeft : [
									new sap.m.Button("Add1", {
					   					 text: "create",
					  					 press: [ function(){
					  						formNewNotif.open(); 
					  						
					  							}]
										 })
								]
						})			 

			});
	
	
	
	
	//create SplitApp()
	var oSplitApp = new sap.m.SplitApp({
		detailPages: [oDetailPage],
		masterPages: [oMasterPage],
		initialDetail: "detail",
		initialMaster: "master",
		afterMasterOpen: function(){
			jQuery.sap.log.info("master is opened");
		},
		afterMasterClose: function(){
			jQuery.sap.log.info("master is closed");
		}
	});

	if(jQuery.device.is.tablet || jQuery.device.is.desktop){
		oSplitApp.setDefaultTransitionNameDetail("fade");	
	}

	oSplitApp.placeAt("body");
</script>
</head>
<body id="body" class="sapUiBody">
</body>
</html>
